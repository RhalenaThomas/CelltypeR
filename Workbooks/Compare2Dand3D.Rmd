---
title: "R Notebook"
output: html_notebook
---

Integrate and cluster together 2D and 3D data

I'm going to merge the seurat objects


```{r}

# set up the environment

library(Seurat)
library(dplyr)
library(ggplot2)
library(reshape2)


```


# read in the data

```{r}

seu.cells <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/2Dcells_surface/Figure2/FigureStuff/Flowset_SelectSeuratlabels.Rds")

input_path <- paste("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/PaperFigures/","All9MOannaote.12072022.Rds")

seu.hmo <- readRDS(input_path)

AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")



```

Integrate the two datasets

```{r}

# rename orgi.ident
seu.cells$orig.ident <- '2Dcells'
seu.hmo$orig.ident <- 'hMO'
# create a matching meta-data file with cell types 'Lables'
Idents(seu.hmo) <- 'cell.types'
seu.hmo$Lables <- Idents(seu.hmo)

# first merge
# merge the objects
seu.int <- merge(seu.hmo, y=seu.cells, add.cell.ids = c("hMO","cells"), project = "Integrate_hMO_cells")
seu.int

unique(sapply(X = strsplit(colnames(seu.int), split = "_"), FUN = "[", 1))
table(seu.int$orig.ident)



```


I didn't integrate the object is it only merge and now I'll process.



```{r}

seu.int <- ScaleData(seu.int, verbose = FALSE)
seu.int <- FindVariableFeatures(seu.int)
seu.int <- RunPCA(seu.int, npcs = 30, verbose = FALSE)
seu.int <- RunUMAP(seu.int, reduction = "pca", features = AB)
seu.int <- FindNeighbors(seu.int, reduction = "pca")
seu.int <- FindClusters(seu.int, resolution = 0.5)


```

```{r}

#DimPlot(seu.int)
DimPlot(seu.int, group.by = "orig.ident")

DimPlot(seu.int, group.by = 'Lables', split.by = 'orig.ident')

DimPlot(seu.hmo, group.by = 'Lables')
DimPlot(seu.cells, group.by = 'Lables')
DimPlot(seu.int, group.by = 'Lables')


DimPlot(seu.int, group.by = 'seurat_clusters')


```


See the labels already assigned in the clusters

```{r}


t.lables <- as.data.frame(table(seu.int$seurat_clusters, seu.int$Lables))
t.lables$Freq <- as.double(t.lables$Freq)




# try bar chart
ggplot(t.lables, aes(y = Freq, x = Var1, fill = Var2)) + geom_bar(position = "stack", stat= "identity")

# find the top 2 in cell in the group

top.labs <- t.lables  %>% group_by(Var1)  %>% top_n(3, Freq)
top.labs

top.lab <- t.lables  %>% group_by(Var1)  %>% top_n(1, Freq)
top.lab






```


Downsample the Organoids and add another metadata to better visualize
I'll have to repeat the merger




```{r}


# rename orgi.ident
seu.cells$orig.ident <- '2Dcells'
Idents(seu.cells) <- 'Lables'
seu.cells$assigned.celltypes <- Idents(seu.cells)
Idents(seu.cells) <- 'Batch'
seu.cells$source <- Idents(seu.cells)



seu.hmo$orig.ident <- 'hMO'
# create a matching meta-data file with cell types 'Lables'
Idents(seu.hmo) <- 'cell.types'
seu.hmo$Lables <- Idents(seu.hmo)
seu.hmo$source <- 'hMO'


Idents(seu.hmo) <- 'cell.types'
seu.hmo.sub <- subset(seu.hmo, downsample = 5000)
table(seu.hmo.sub$cell.types)



# merge the objects
seu.int <- merge(seu.hmo.sub, y=seu.cells, add.cell.ids = c("hMO","cells"), project = "Integrate_hMO_cells")


unique(sapply(X = strsplit(colnames(seu.int), split = "_"), FUN = "[", 1))
table(seu.int$orig.ident)




```


Process again

```{r}
seu.int <- ScaleData(seu.int, verbose = FALSE)
seu.int <- FindVariableFeatures(seu.int)
seu.int <- RunPCA(seu.int, npcs = 30, verbose = FALSE)
seu.int <- RunUMAP(seu.int, reduction = "pca", features = AB)
seu.int <- FindNeighbors(seu.int, reduction = "pca")
seu.int <- FindClusters(seu.int, resolution = 0.5)

```


```{r}

DimPlot(seu.int)
DimPlot(seu.int, group.by = 'source')




```
The data were not integrated and are not well aligned

Check to see if there are cells from both 2D and 3D in each cluster

```{r}

t.lables <- as.data.frame(table(seu.int$seurat_clusters, seu.int$source))
t.lables$Freq <- as.double(t.lables$Freq)

# try bar chart
ggplot(t.lables, aes(y = Freq, x = Var1, fill = Var2)) + geom_bar(position = "stack", stat= "identity")

# have a look at the cell types from organoids or 2d cells in each
t.lables <- as.data.frame(table(seu.int$seurat_clusters, seu.int$cell.types))
t.lables$Freq <- as.double(t.lables$Freq)

# try bar chart
ggplot(t.lables, aes(y = Freq, x = Var1, fill = Var2)) + geom_bar(position = "stack", stat= "identity")




```

Maybe the integration will work if I down sample both initial objects

```{r}

Idents(seu.cells) <- 'Batch'
seu.cell.sub <- subset(seu.cells, downsample = 5000)
table(seu.cell.sub$Batch)

```


```{r}

# merge the objects
seu.int <- merge(seu.hmo.sub, y=seu.cell.sub, add.cell.ids = c("hMO","cells"), project = "Integrate_hMO_cells")


unique(sapply(X = strsplit(colnames(seu.int), split = "_"), FUN = "[", 1))
table(seu.int$orig.ident)


#save this integrated file before 
saveRDS(seu.int, paste(output_path,"int.seu.down.Rds"))



```


```{r}
output_path <- "/Users/rhalenathomas/Documents/Projects_Papers/PhenoID/ForFigures/"

seu.int <- readRDS(paste(output_path,"int.seu.down.Rds"))

```




```{r}

# see if find anchors can work now

# integrate the datasets
o.list <- SplitObject(seu.int, split.by = "orig.ident")

# Seurat recommends normalizing and finding variable features before integration
for (i in 1:length(o.list)){
  o.list[[i]] <- NormalizeData(o.list[[i]], verbose = FALSE)
  o.list[[i]] <- SCTransform(o.list[[i]], verbose = FALSE)
  o.list[[i]] <- FindVariableFeatures(o.list[[i]], selection.method = "vst")
}

# This object was done with the normalization





```


Need PCA for integration?

```{r}
seu.int <- ScaleData(seu.int, verbose = FALSE)
seu.int <- FindVariableFeatures(seu.int)
seu.int <- RunPCA(seu.int, npcs = 30, verbose = FALSE)

```




```{r}


combined.features <- SelectIntegrationFeatures(object.list = o.list, nfeatures = 13)
o.list <- PrepSCTIntegration(object.list = o.list, anchor.features = combined.features,  verbose = FALSE)


o.anchors <- FindIntegrationAnchors(object.list = o.list, anchor.features = AB, normalization.method = 'SCT')

saveRDS(o.anchors, paste(output_path,"anchors.RDS"))

sub.int <- IntegrateData(anchorset = o.anchors, normalization.method = 'SCT', dims = 1:13)

```

Cannot seem to integrate with Seurat.  Maybe I can integrate the data at the starting point, one file at a time. Something to look at later after the pre-processing functions are done.

It might also be interesting to compare the 2D and 3D correlation of expression between clusters









