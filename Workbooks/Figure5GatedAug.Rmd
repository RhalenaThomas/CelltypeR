---
title: "R Notebook"
output: html_notebook
---

Figure 4: Visualization of annotated data from the full data set of 9 hMOs.
UMAP of cell type annotations
UMAP split by iPSC line (genetic background)

The data is prepared in "hMO_3genotypeAllCells.R"

```{r}
require(Seurat)
require(tidyverse)
require(CelltypeR)

```
Based on the hypergate results cells were gated in FlowJo
Then gated fcs files are used here.



```{r}
# load libraries

library(Seurat)
library(tidyverse)
library(ggplot2)
library(CelltypeR)


```


```{r}
# read in the cell types gated in FlowJo
# make seurat object
input_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/FlowDataFiles/Exported_gating_9MBO/HyperGatesAug2023all9MBO/UpdatedGates"
flowset <- fsc_to_fs(input_path, downsample = 5000)



library(flowWorkspace)  # this library has the function "sampleNames"
sampleNames(flowset)


sampleNames(flowset) <- c("Astrocytes","Endothelial","Epithelial","Glial_lineage","Neural_lineage","Neurons1",
                           "Neurons2", "NPC", "Oligodendrocytes","RadialGlia")
sampleNames(flowset)

```

```{r}

plotdensity_flowset(flowset)
flowset_biexp <- harmonize(flowset, processing = 'biexp')

plotdensity_flowset(flowset_biexp)

```

Align and create dataframe of area expression values FSC-A for each channel/Marker

```{r}

flowset_align <- harmonize(flowset, processing = 'align', 
                           two_peaks = c(8:22),
                       one_peak = c(1:7), threshold = 0.01)

flowset_retro <- harmonize(flowset, processing = 'retro', 
                           two_peaks =  c(8:22),
                       one_peak = c(1:7), threshold = 0.01)

df <- flowset_to_csv(flowset)
df.align <- flowset_to_csv(flowset_retro)

head(df)
summary(df)

write.csv(df, "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/FlowsetGatedCellPopsSeptNoAlignUpdated.csv")
write.csv(df.align, "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/FlowsetGatedCellPopsSeptRetroAlign.csv")




```


```{r}
AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")
seu <- make_seu(df.align, AB_vector = AB)
seu <- ScaleData(seu)
seu <- RunPCA(seu, features = AB, dims = 1:10)
seu <- RunUMAP(seu, features = AB, n.neighbors = 40)

DimPlot(seu, group.by = "Sample", label = TRUE)

```



Make the seurat object without alignment

```{r, fig.width=5}

AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")
seu2 <- make_seu(df, AB_vector = AB)




seu2 <- ScaleData(seu2)
seu2 <- RunPCA(seu2, features = AB, dims = 1:10)
seu2 <- RunUMAP(seu2, features = AB, n.neighbors = 40)

DimPlot(seu2, raster = FALSE, label = TRUE)

DimPlot(seu2, split.by = "Sample", ncol = 3)

table(seu2$Sample)


```

Cluster
```{r}
seu2 <- get_clusters(seu2, method = "louvain",
                         df_input = df,
                         k = 20,
                         resolution = c(0,0.8,1.2),
                         plots = FALSE,
                         save_plots = FALSE)
seu2 <- FindClusters(seu2, resolution = 1.8)
DimPlot(seu2, raster = FALSE, label = TRUE, group.by = "seurat_clusters")
DimPlot(seu2, split.by = "Sample", ncol = 3, group.by = "seurat_clusters", raster = FALSE)


```


```{r}
AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")
seu <- make_seu(df, AB_vector = AB)
seu <- ScaleData(seu)
seu <- RunPCA(seu, features = AB, dims = 1:10)
seu <- RunUMAP(seu, n.neighbors = 20, dims = 1:10, a = 0.7, b = 0.7)

DimPlot(seu, group.by = "Sample")
DimPlot(seu, label = TRUE, split.by = "Sample")



```

```{r}
seu <- get_clusters(seu, method = "louvain",
                         df_input = df,
                         k = 20,
                         resolution = c(0,0.5,1.2,1.8),
                         plots = FALSE,
                         save_plots = FALSE)
DimPlot(seu, raster = FALSE, label = TRUE, group.by = "seurat_clusters")
DimPlot(seu, split.by = "Sample", ncol = 3, group.by = "seurat_clusters", raster = FALSE, label = TRUE)

```



Visualize marker expression
```{r}
for (i in AB) {
  print(FeaturePlot(seu, features = i, min.cutoff = 'q1', max.cutoff = 'q97', label = TRUE, raster = FALSE))
}

```


Heatmap of marker expression by cluster

```{r}
library(data.table)
length(unique(seu$seurat_clusters))
plotmean(plot_type = 'heatmap',seu = seu, group = 'RNA_snn_res.1.8',
         markers = AB, 
               var_names = c(0:34), slot = 'scale.data', xlab = "Cluster",
               ylab = "Markers")



```

```{r}
 t.lables <- as.data.frame(table(seu$RNA_snn_res.1.8, seu$Sample))
  t.lables$Freq <- as.double(t.lables$Freq)
  colnames(t.lables) <- c("Cluster", "Label","Freq")
  top.labs <- t.lables  %>% group_by(Cluster) %>% top_n(5, Freq)
  sort.tops <- top.labs %>% as.data.frame() %>% arrange(desc(Freq))  %>% arrange(Cluster)

  
  t.lables <- as.data.frame(table(seu$RNA_snn_res.1.8, seu$Sample))
  t.lables$Freq <- as.double(t.lables$Freq)
  colnames(t.lables) <- c("Cluster", "Label","Freq")
  top.labs1 <- t.lables  %>% group_by(Cluster) %>% top_n(1, Freq)
  sort.tops1 <- top.labs1 %>% as.data.frame() %>% arrange(desc(Freq))  %>% arrange(Cluster)
  print(sort.tops1)
  
cell.ann <- get_annotation(seu, seu.cluster = seu$RNA_snn_res.1.8, 
                          seu.label = seu$Sample, top_n = 1, 
                          Label = "Cells")
print(sort.tops)
  
  
```





Calculate the correlations

```{r}
reference_data <- read.csv(reference_path <- "/Users/rhalenathomas/GITHUB/CelltypeR/ExampleOuts/FinalReferenceMatrix.csv")
# the reference matrix need to be in the format cell types as rows and markers as columns
# there is a column X with the cell type names
df1 <- reference_data
rownames(df1) <- df1$X # add row names (these are the markers)
df1 <- df1 %>% select(-"X") # remove the column with the marker names
colnames(df1) <- c("Astrocytes","Endothelial","Epithelial","Neurons",
                   "NPC","OPC","Oligo","RadialGlia","StemCell")
df.ref <- as.data.frame(t(df1))
df.ref$X <- rownames(df.ref)

df_test <- read.csv("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/FlowsetGatedCellPopsSeptNoAlignUpdated.csv") # the X column needs to be the first column

summary(df_test)

cor <- find_correlation(test = df_test, 
                        reference = df.ref, 
                        min_corr = 0.25, 
                        min_diff = 0.01)

write.csv(cor, "GatedCellsCorPredictUpdated.csv")

plot_corr(cor, threshold = 0.25, min_cells = 100)

```


Visualize correlation predictions on UMAP per cell, filtering out cell types with less than 500 cells. 

```{r}

# add the labels
# add the correlation predictions to the meta data
seu <- AddMetaData(object=seu, metadata=cor$cell.label, col.name = 'cor.labels')

Idents(seu) <- 'cor.labels'
library(dplyr)
# filter cell types less than 100 cells and filter out unassigned from the 0.35 threshold with 0.05 double cell threshold
thresh = 100
freq.cor <- data.frame(table(seu$cor.labels))
levels(seu)

keep <- freq.cor %>% filter(Freq > thresh)
# sort by frequency
# sorted_df <- df %>% arrange(desc(Freq))
# alphabetical
sorted_df <- keep %>% arrange(Var1)
cell.order <- as.character(keep$Var1)


#filter.out <- c(as.character(df.ft$Var1),"unassigned")
seu.sub <- subset(seu, ident = cell.order, invert = FALSE)


DimPlot(seu.sub, order = rev(cell.order), raster = FALSE, label = TRUE)



```

Get the CAM predictions

```{r, fig.width=10}

plot_lab_clust(seu, seu$RNA_snn_res.1.8, seu$cor.labels, filter_out = c( "Unassigned","Mixed"))


 t.lables <- as.data.frame(table(seu$RNA_snn_res.1.8, seu$cor.labels))
  t.lables$Freq <- as.double(t.lables$Freq)
  colnames(t.lables) <- c("Cluster", "Label","Freq")
  top.labs <- t.lables  %>% group_by(Cluster) %>% top_n(5, Freq)
  sort.tops <- top.labs %>% as.data.frame() %>% arrange(desc(Freq))  %>% arrange(Cluster)
  print(sort.tops)

  
  cor.ann <- get_annotation(seu, seu.cluster = seu$RNA_snn_res.1.8, 
                          seu.label = seu$cor.labels, top_n = 1, 
                          filter_out = c("Unknown","unknown","Mixed", 
                                         "unassigned","Unassigned"), 
                          Label = "CAM")
  

```



Random Forest Classifier

```{r}

# Random Forest classifier trained with annotations from subset of 9 MBO cells. 
# read in the saved model
rf <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/RFM/RFM_all9hMOAB.RDS")

# test random forest function takes in the seurat object to have cells predicted and the trained model.  Must be trained with the same antibodies

rfm.pred <- RFM_predict(seu, rf)
head(rfm.pred)
unique(rfm.pred$Prediction)


# add the predictions to the seurat object
seu <- AddMetaData(object=seu, metadata= as.factor(rfm.pred$Prediction), col.name = 'rfm.pred')



celltypes <- unique(seu$rfm.pred)
sorted <- as.character(factor(sort(as.character(celltypes))))

DimPlot(seu, group.by = 'rfm.pred', raster = FALSE, label = TRUE, order = rev(sorted))

 



```

```{r}
table(seu2$Sample, seu2$rfm.pred)
```




```{r}
 
plot_lab_clust(seu, seu$RNA_snn_res.1.8, seu$rfm.pred, filter_out = c( "Unassigned","Mixed"))


 t.lables <- as.data.frame(table(seu$RNA_snn_res.1.8, seu$rfm.pred))
  t.lables$Freq <- as.double(t.lables$Freq)
  colnames(t.lables) <- c("Cluster", "Label","Freq")
  top.labs <- t.lables  %>% group_by(Cluster) %>% top_n(5, Freq)
  sort.tops <- top.labs %>% as.data.frame() %>% arrange(desc(Freq))  %>% arrange(Cluster)
  print(sort.tops)

  
  rfm.ann <- get_annotation(seu, seu.cluster = seu$RNA_snn_res.1.8, 
                          seu.label = seu$rfm.pred, top_n = 1, 
                          filter_out = c("Unknown","unknown","Mixed", 
                                         "unassigned","Unassigned"), 
                          Label = "rfm.pred")
  
  
  
```


Seurat label transfer

```{r}
# read in the reference matrix
seu.r<- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure4/All9MOannaoteAug.RDS") 

table(seu.r$Celltypes)

Idents(seu.r) <- "Celltypes"
seu.r <- subset(seu.r, downsample = 5000)

seu.r <- ScaleData(seu.r, features = AB)
seu.r <- RunPCA(seu.r, features = AB, verbose = FALSE, approx = FALSE)


```



```{r}
# notes this function automatically selects the total number of markers as the dim.  So max dim = 1:13 here. 
seu <- seurat_predict(seu, seu.r, ref_id = 'Celltypes', 
                        refdata = seu.r$Celltypes,
                           down.sample = "none", 
                        markers = AB)

DimPlot(seu, group.by = 'seu.pred', raster = FALSE, label = TRUE)


 

```

```{r}
plot_lab_clust(seu, seu$RNA_snn_res.1.8, seu$seu.pred, filter_out = c( "Unassigned","Mixed"))


 t.lables <- as.data.frame(table(seu$RNA_snn_res.1.8, seu$seu.pred))
  t.lables$Freq <- as.double(t.lables$Freq)
  colnames(t.lables) <- c("Cluster", "Label","Freq")
  top.labs <- t.lables  %>% group_by(Cluster) %>% top_n(5, Freq)
  sort.tops <- top.labs %>% as.data.frame() %>% arrange(desc(Freq))  %>% arrange(Cluster)
  print(sort.tops)

  
  seu.ann <- get_annotation(seu, seu.cluster = seu$RNA_snn_res.1.8, 
                          seu.label = seu$seu.pred, top_n = 1, 
                          filter_out = c("Unknown","unknown","Mixed", 
                                         "unassigned","Unassigned"), 
                          Label = "seu.pred")
```


See the predictions for each method

```{r}
an.list <- list(cor.ann, rfm.ann, seu.ann, cell.ann)
df.an <- annotate_df(an.list)
df.an
setwd("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/")
write.csv(df.an, "GatedAllannotationPredsTopNewUpdate.csv")




```



Add annotations

```{r, fig.width=4}

# from first gating Seu2
cluster.ids <- c("GL","Neur2","GL", "NL","RG1a", # 0-4
                 "Neur1","Endo","NL","Neur1","NPC", #5-9 
                 "GL","Neur1","Endo","Astro1","Epi", #10-14 
                 "Neur2","NPC","Oligo-Neurons2","Astro1","Epi",    #15-19
                 "Epi","Neur2","NPC","Epi","Neur1", #20-24
                 "Astro1","Neur2","Astro1","Endo","Neur1",
                 "NL","Oligo","NL","Neur2","NPC", "RG1"
                 )


seu2 <- annotate(seu2, annotations = cluster.ids, 
                  to_label= "seurat_clusters", 
                  annotation_name = "Annotations1")

DimPlot(seu2,label = TRUE, repel = TRUE ,raster = FALSE,
        label.size = 6)

DimPlot(seu2,label = TRUE, repel = TRUE ,raster = FALSE,
        label.size = 2, split.by = "Sample", ncol = 3)

DimPlot(seu2,label = TRUE, repel = TRUE ,raster = FALSE,
        label.size = 2, split.by = "Sample", ncol = 3, group.by = "seurat_clusters")


```


```{r, fig.width=5}
# from adjusted gates with fewer cell types
cluster.ids <- c("NL","GL","GL", "GL","Epi", # 0-4
                 "Neur2","NL","RG1","Neurons1-2","Neur2-oligo", #5-9 
                 "Epi","NPC","Endo","Astro1","RG1", #10-14 
                 "NPC","Neur1","NPC","Endo","Neur1",    #15-19
                 "Astro1","Neur1","Oligo","Neur2","NL", #20-24
                 "NPC","Astro1","Endo","RG3","Astro1",
                 "Neur2","Endo","RG1","NPC", "Oligo"
                 )


seu <- annotate(seu, annotations = cluster.ids, 
                  to_label= "seurat_clusters", 
                  annotation_name = "Annotations1")

DimPlot(seu,label = TRUE, repel = TRUE ,raster = FALSE,
        label.size = 6)
```


Change annotation to full names to set the order

```{r}
Idents(seu) <- "Annotations1"
levels(seu)

cluster.ids <- c("Neural-lineage","Glial-lineage","Epithelial","Neurons2",
                 "RadialGlia1","Neurons1and2","Neurons2andOligo","NPC","Endothelial",
                 "Astrocytes1","Neurons1","Oligodendrocytes","RadialGlia3")

seu <- annotate(seu, annotations = cluster.ids, 
                  to_label= "Annotations1", 
                  annotation_name = "Celltypes")


```





```{r}
unique(seu$Celltypes)



cell.order <- c("Astrocytes1","RadialGlia1","RadialGlia3","Glial-lineage",
                "Epithelial","Endothelial","Neurons1",
                "Neurons2","Neurons1and2","Neurons2andOligo","NPC",
                "Neural-lineage","Oligodendrocytes")
 
 clust.colours <- c("chocolate2",# Astrocytes 1
                   #"darkorange", # Astrocytes 2
                   #"orange", #Astro
                   "pink", # RG1
                   #"deeppink",# RG1a
                   #"plum1", #RG2
                   "lightpink3",# RG stemlike
                   "mistyrose2", # Glia-lineage
                   "steelblue3",# epithelial
                   "deepskyblue", # endothelial
                   #"blue", # epi-endo
                   "mediumpurple1",# neurons 1
                   "purple",# Neurons2
                   "mediumpurple3", # Neurons1 and 2
                   "grey", # Neurons2 and oligo
                   #"darkgrey",
                   "plum3", # NPC
                   #"tomato3",# stem like
                   "mediumslateblue", # Neural lineage
                   "seagreen3",#Oligo
                   "olivedrab4", # OPC
                   "darkseagreen3",#OPC like
                   
                   "burlywood3" #extra 
                   )

 # need to set the factor to control the order
 
 seu$Celltypes <- factor(seu$Celltypes, levels = cell.order)
 
 
 
```




quick check

```{r}
proportionplots(seu, seu.var = seu$Sample, seu.lable = seu$Celltypes, 
                groups = "Gated samples",  
                my_colours = clust.colours)


setwd("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/")
pdf("GatedPopsCelltypesBarchart.pdf", width = 6, height = 4)
proportionplots(seu, seu.var = seu$Sample, seu.lable = seu$Celltypes, 
                groups = "Gated samples",  
                my_colours = clust.colours)
dev.off()



```


UMAP with cell type labels

```{r}
DimPlot(seu, cols = clust.colours, shuffle = FALSE, 
        raster=FALSE, pt.size = 0.1, label = TRUE, 
        group.by = "Celltypes")




```


UMAP by gated cell type sample

```{r}
#unique(seu$Sample)

sample.colours  <- c("chocolate2",# Astrocytes 1
                   "steelblue3",# epithelial
                   "deepskyblue", # endothelial
                   "mistyrose2", # Glia-lineage
                   "mediumslateblue", # Neural lineage
                   "mediumpurple1",# neurons 1
                   "purple",# Neurons2
                   "plum3", # NPC
                   "seagreen3",#Oligo
                   "pink" # RG1
                   )



DimPlot(seu, cols = sample.colours, shuffle = TRUE, 
        raster=FALSE, pt.size = 0.1, label = TRUE, 
        group.by = "Sample") +
theme(legend.text = element_text(size=16), axis.title.y = element_text(size=16), 
         axis.title.x = element_text(size=16), axis.text.y = element_text(size =16),
        axis.text.x = element_text(size =16))

setwd("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/")
pdf("GatedCellPopsUMAP.pdf", width = 9, height = 4.5)
DimPlot(seu, cols = sample.colours, shuffle = TRUE, 
        raster=FALSE, pt.size = 0.1, label = FALSE, 
        group.by = "Sample") +
theme(legend.text = element_text(size=16), axis.title.y = element_text(size=16), 
         axis.title.x = element_text(size=16), axis.text.y = element_text(size =16),
        axis.text.x = element_text(size =16))
dev.off()


```

Table of cell types per population

```{r}

df <- as.data.frame(table(seu$Sample,seu$Celltypes))

colnames(df)
dim(df)
library(tidyr)

tb <- pivot_wider(df, names_from = "Var1", values_from = "Freq")

tb

```






save this object - no OPC, OPC-like or Stem-cell

```{r}
saveRDS(seu, "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/GatedPopsSept5SomeCellGatedandLabels.RDS")

seu <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/GatedPopsSept5SomeCellGatedandLabels.RDS")

```



Previous gating wiht all cell types

```{r}
saveRDS(seu2, "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/GatedPopsSept4An1.RDS")

```



