---
title: "May 10th and June 10th new hMOs"
output: html_notebook
---

Set up the workspace

```{r}

require(Seurat)
require(tidyverse)
require(CelltypeR)


```

Preprocessing hMO datasets.  Live single cells gated in FlowJo

Read in fsc files


```{r}
# input path is the pathway to the folder with the data

input_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/GatingPlanExperiment/May10June10_livegating/"
flowset <- fsc_to_fs(input_path, downsample = 20000)


library(flowWorkspace)  # this library has the function "sampleNames"
sampleNames(flowset)

```


2. Make flowset object
- rename for with shorter names
- the data are from two experiments.  The May experiment has two different batches, two replicates each.  The June experiment has 1 batch and three replicates. 

```{r}
# rename samples 
sampleNames(flowset) <- c("M10_A","M10_B","M10_C","M10_D",
                           "J10_A", "J10_B", "J10_C")
sampleNames(flowset)

```


Check the data object


```{r}
#### need to change this function to detect peaks or at least have the user add the column number
### check the density plots above to see which have peaks

plotdensity_flowset(flowset)


plotdensity_flowset(flowset_biexp)

```
Note the ssc-h values are very different between May and June.  These value are not used in the clustering.



```{r}

#### need to change this function to detect peaks or at least have the user add the column number
### check the density plots above to see which have peaks check in plots above


flowset_align <- harmonize(flowset, processing = 'align', 
                           two_peaks = c(1),
                       one_peak = c(2:20), threshold = 0.01)

flowset_retro <- harmonize(flowset, processing = 'retro', 
                           two_peaks = c(1),
                       one_peak = c(2:20), threshold = 0.01)


```


Create the data frame and save for later

```{r}
df <- flowset_to_csv(flowset_retro)

head(df)

write.csv(df, "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/FlowsetAug29.csv")



```





Now create the Seurat object

```{r}
AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")

seu <- make_seu(df, AB_vector = AB)

DimPlot(seu, raster = FALSE, group.by = "Sample", reduction = "pca")
DimPlot(seu, raster = FALSE, group.by = "Sample", reduction = "umap")




```





Cluster


```{r}

seu <- get_clusters(seu, method = "louvain",
                         df_input = df,
                         k = 60,
                         resolution = 0.8,
                         plots = FALSE,
                         save_plots = FALSE)

DimPlot(seu, raster = FALSE, group.by = "seurat_clusters", label = TRUE)


```



```{r}
for (i in AB) {
  print(FeaturePlot(seu, features = i, min.cutoff = 'q1', max.cutoff = 'q97', label = TRUE, raster = FALSE))
}

```




```{r}
seu <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/FlowDataFiles/PresortingMay10June10/NewDataannaote.14122022.Rds")
```



Now annotate the cell types using:
1.Visualization of heatmaps 
2. correlation predictions
3. RandomForest
4. Seurat transfer


Visualize expression

```{r}
AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")
Idents(seu) <- "seurat_clusters"
for (i in AB) {
  print(FeaturePlot(seu, features = i, min.cutoff = 'q1', max.cutoff = 'q97', label = TRUE, raster = FALSE, slot = "scale.data"))
}


```


Heat map by cluster

```{r}
library(data.table)

plotmean(plot_type = 'heatmap',seu = seu, group = 'seurat_clusters',
         markers = AB, 
               var_names = c(0:29), slot = 'scale.data', xlab = "Cluster",
               ylab = "Markers")
```

Correlation predictions and summary bar charts

```{r}
# correlation predictions
reference_data <- read.csv(reference_path <- "/Users/rhalenathomas/GITHUB/CelltypeR/ExampleOuts/FinalReferenceMatrix.csv")
# the reference matrix need to be in the format cell types as rows and markers as columns
# there is a column X with the cell type names
df1 <- reference_data
rownames(df1) <- df1$X # add row names (these are the markers)
df1 <- df1 %>% select(-"X") # remove the column with the marker names
colnames(df1) <- c("Astrocytes","Endothelial","Epithelial","Neurons",
                   "NPC","OPC","Oligo","RadialGlia","StemCell")
df.ref <- as.data.frame(t(df1))
df.ref$X <- rownames(df.ref)

input_df <- read.csv("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/FlowDataFiles/PresortingMay10June10/flowsetMayJune10.csv")

cor <- find_correlation(test = input_df, 
                        reference = df.ref, 
                        min_corr = 0.35, 
                        min_diff = 0.01)

plot_corr(cor, threshold = 0.35, min_cells = 200)

```

Visualize correlation results and get annotation per cluster as well as top 5 most frequent predicted cell types by cluster

```{r}

#seu <- AddMetaData(object=seu, metadata=cor$cell.label, col.name = 'cor.labels')

cor.ann <- get_annotation(seu, seu.cluster = seu$seurat_clusters, 
                          seu.label = seu$cor.labels, top_n = 3, 
                          filter_out = c("Unknown","unknown","Mixed", 
                                         "unassigned","Unassigned"), 
                          Label = "CAM")

# top 5 per groups
t.lables <- as.data.frame(table(seu$seurat_clusters, seu$cor.labels))
  t.lables$Freq <- as.double(t.lables$Freq)
  colnames(t.lables) <- c("Cluster", "Label","Freq")
  top.labs <- t.lables  %>% group_by(Cluster) %>% top_n(5, Freq)
  sort.tops <- top.labs %>% as.data.frame() %>% arrange(desc(Freq))  %>% arrange(Cluster)
  print(sort.tops)
  
#write.csv(sort.tops,"Cor035top5pred.csv")
cor.pred.top5 <- read.csv("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/Cor035top5pred.csv")
  
```

```{r}
# filter cells out that are double labelled and very few 
thresh = 200
freq.cor <- data.frame(table(seu$cor.labels))

keep <- freq.cor %>% filter(Freq > thresh)
# sort by frequency
# sorted_df <- df %>% arrange(desc(Freq))
# alphabetical
cellident <- as.character(keep$Var1)

Idents(seu) <- "cor.labels"
seu.sub <- subset(seu, ident = cellident, invert = FALSE)

plot_lab_clust(seu.sub, seu.sub$seurat_clusters, seu.sub$cor.labels, filter_out = "Unassigned")

```

UMAP with cell types predicted > 200

```{r, fig.width=4}
DimPlot(seu.sub, group.by = "cor.labels", raster = FALSE, label = TRUE)
```


Predictions with RFM

```{r}
# Random Forest predictions

# read in the saved model
rf <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/RFM/RFM_all9hMOAB.RDS")


AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")


rfm.pred <- RFM_predict(seu, rf, markers = AB)
head(rfm.pred)
unique(rfm.pred$Prediction)
seu <- AddMetaData(object=seu, metadata= as.factor(rfm.pred$Prediction), col.name = 'rfm.pred2')
DimPlot(seu, group.by = 'rfm.pred2', raster = FALSE, label = TRUE, repel = TRUE)

plot_lab_clust(seu, seu$seurat_clusters, seu$rfm.pred2, filter_out = c( "Unassigned","Mixed"))

```

Top 5 predictions with RFM and the top prediction per cluster

```{r}

rfm.ann <- get_annotation(seu, seu.cluster = seu$seurat_clusters, 
                          seu.label = seu$rfm.pred2, top_n = 3, 
                          filter_out = c("Unknown","unknown","Mixed", 
                                         "unassigned","Unassigned"), 
                          Label = "RFM")

# top 5 per groups
t.lables <- as.data.frame(table(seu$seurat_clusters, seu$rfm.pred2))
  t.lables$Freq <- as.double(t.lables$Freq)
  colnames(t.lables) <- c("Cluster", "Label","Freq")
  top.labs <- t.lables  %>% group_by(Cluster) %>% top_n(5, Freq)
  sort.tops <- top.labs %>% as.data.frame() %>% arrange(desc(Freq))  %>% arrange(Cluster)
  print(sort.tops)
  
#write.csv(sort.tops,"RFMtop5pred.csv")
  
rfm.pred.top5 <- read.csv("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/RFMtop5pred.csv")

```

```{r}
#saveRDS(seu,"/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/SeuNewAIW_labelled.RDS")

#seu <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/SeuNewAIW_labelled.RDS")

Idents(seu) <- "seurat_clusters"

seu.new.sub <- subset(seu, downsample = 500)
table(seu.new.sub$seurat_clusters)
seu.new.sub <- ScaleData(seu.new.sub, features = AB)
DimPlot(seu.new.sub)


```



Predict cell types with Seurat label transfer

```{r}
# seurat transfer anchor predictions
# Full annotated dataset, this has no unknown cells

seu.r<- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure4/All9MOannaoteAug.RDS") 

Idents(seu.r) <- 'Celltypes'
seu.r <- subset(seu.r, downsample = 5000)

table(seu.r$Celltypes)

DimPlot(seu.r)
#DimPlot(seu, reduction = "pca", group.by = "Sample", raster = FALSE)
AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")
seu.r <- ScaleData(seu.r, features = AB)
seu.r <- RunPCA(seu.r, features = AB, verbose = FALSE, approx = FALSE)



```



Predict with reference data

```{r}
# seurat predict will add the predictions directly 
# make sure to select the labels you want in the reference data seu.r


AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")
seu <- seurat_predict(seu.new.sub, seu.r, ref_id = 'Celltypes', 
                        refdata = seu.r$Celltypes,
                           down.sample = "none", 
                        markers = AB)


DoHeatmap(seu.new.sub, features = AB)

  # find anchors
Idents(seu.r) <- "Celltypes"
anchors <- FindTransferAnchors(reference = seu.r,
                                 query = seu.new.sub, 
                               features = AB,npcs = 12,
                                 dim= 1:12, n.trees = 25, verbose = FALSE, reduction = "cca"
                               )
  
ancn <- dim(as.data.frame(anchors@anchors))[1]

an <- dim(ancn)[1]

predictions <- TransferData(anchorset = anchors, refdata = seu.r$Celltypes,
                               k.weight = 8)
seu <- AddMetaData(seu, metadata = predictions$predicted.id,
                       col.name = 'seu.pred')




```


Make a table with the top predictions per cell type from 3 prediction methods

```{r}
an.list <- list(cor.ann, rfm.ann, seu.ann)
df.an <- annotate_df(an.list)
df.an
write.csv(df.an, "annotationPredsTop1.csv")

```





Annotated clusters of two new AIW002-02 hMO batches

```{r}

clust.colours <- c("chocolate2",# Astrocytes 1
                   "darkorange", # Astrocytes 2
                   "pink", # RG1
                   "deeppink",# RG1a
                   "plum1", #RG2
                   "lightpink3",# RG3
                   "mistyrose2", # Glia-lineage
                   "steelblue3",# epithelial
                   "deepskyblue", # endothelial
                   "mediumpurple1",# neurons 1
                   "purple",# Neurons2
                   "plum3", # NPC
                   "mediumslateblue", # Neural lineage
                   "seagreen3",#Oligo
                   "olivedrab4", # OPC
                   "darkseagreen3",#OPC like
                   "tomato3",# stem like
                   "burlywood3" #extra 
                   )





```






Heatmaps

```{r}
DoHeatmap(seu, group.by = 'Cell_types', features = AB, size= 5,slot = "scale.data",
        angle = 90,label = TRUE,
        hjust = 0, group.bar.height = 0.05, disp.max = 2, disp.min = -1.5) + scale_fill_gradientn(colors = c("#154c79", "#eeeee4", "#e28743")) + 
  theme(axis.text.y = element_text(size = 13)) 

```


Cell Types for figures

```{r}

Idents(seu) <- "RNA_snn_res.1.2"

cluster.ids <- c("Mixed","Astrocytes 1","Radial Glia 1","Astrocytes 2","Radial Glia 1",   # 0-4
                 "Neurons 2","Radial Glia 2","Neurons 1","Radial Glia 2","Astrocytes 1",  #5-9
                 "Neurons 2","Epithelial", "Neurons 2","Radial Glia 1", "Astrocytes 1", #10-14
                 "Neurons 1", "OPC", "Astrocytes 2","Stem cell like","Astrocytes 1",  #15-19
                 "Neurons 1", "Endothelial","Astrocytes 1", "Neurons 2","Neurons 2", #20-24
                 "Neurons 1","Neurons 2","Radial Glia 1","NPC","NPC", #25-29
                 "Astrocytes 1","Astrocytes 2","Epithelial","Oligodendrocytes", "Astrocytes 2",
                 "Glia")

names(cluster.ids) <- levels(seu)
seu <- RenameIdents(seu, cluster.ids)
seu$Cell_types <- Idents(seu)


# change the order of the cell types on the legend of the umap
cell.type.order <- c("Astrocytes 1", "Astrocytes 2","Radial Glia 1","Radial Glia 2",
                     "Epithelial","Endothelial","NPC","Neurons 1","Neurons 2",
                     "Oligodendrocytes","OPC","Stem cell like","Glia","Mixed")
cell.type.order <- rev(cell.type.order)

# colour order to match cell type order
clust.colours <- c("chocolate1","orange","lightsalmon", "pink",
                   "steelblue3","deepskyblue","plum3","purple","orchid2",
                   "seagreen3","green","tomato3","burlywood3","grey90","lemonchiffon3","yellow")

Idents <- 'Cell_types'
DimPlot(seu, order = cell.type.order, cols = clust.colours, shuffle = TRUE, raster=FALSE,pt.size = 0.1, label = FALSE, label.size = 6) +
  theme(legend.text = element_text(size=16), axis.title.y = element_text(size=16), 
        axis.title.x = element_text(size=16), axis.text.y = element_text(size =16),
        axis.text.x = element_text(size =16))





```




# Create a seurat object with AIW002 batches from Figures 4 and the new batches

```{r}

```







