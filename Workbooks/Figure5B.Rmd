---
title: "May 10th and June 10th new hMOs"
output: html_notebook
---

Set up the workspace

```{r}

require(Seurat)
require(tidyverse)
require(CelltypeR)


```

Preprocessing hMO datasets.  Live single cells gated in FlowJo

Read in fsc files

```{r}
# input path is the pathway to the folder with the data
flowset <- fsc_to_fs(input_path)
# see the current sample names - these are the file names of the fsc files
sampleNames(flowset3)

```


2. Make flowset object

```{r}
# rename samples 
sampleNames(flowset) <- c("M10_A","M10_B","M10_C","M10_D",
                           "J10_A", "J10_B", "J10_C")
sampleNames(flowset)

```


Check the data object


```{r}
#### need to change this function to detect peaks or at least have the user add the column number
### check the density plots above to see which have peaks
plotdensity_flowset(flowset)

```
Note the ssc-h values are very different between May and June.  These value are not used in the clustering.



```{r}

#### need to change this function to detect peaks or at least have the user add the column number
### check the density plots above to see which have peaks check in plots above

flowset_align <- harmonize(flowset, processing = 'align', 
                           two_peaks = c(1:3,9:length(colnames(transformed_flowset)),
                       one_peak = c(4:8), threshold = 0.001))

flowset_retro <- harmonize(flowset, processing = 'retro', 
                           two_peaks = c(1:3,9:length(colnames(transformed_flowset)),
                       one_peak = c(4:8), threshold = 0.001))


```

See the transformations

```{r}
plotdensity_flowset(flowset)
plotdensity_flowset(transformed_flowset)
plotdensity_flowset(aligned_transformed_flowset)


```
One sample On sample is far out of alignment in Cy5



Save the flowset dataset May10

```{r}
AB <- c("AQP4", "CD24", "CD44","CD184","CD15","HepaCAM","CD29",
                         "CD56", "O4","CD140a","CD133","GLAST","CD71")
df <- flowset_to_csv(flowset_retro)
df <- df %>% select(c(AB,"Sample"))

```


Now create the Seurat object

```{r}

AB <- c("AQP4", "CD24", "CD44","CD184","CD15","HepaCAM","CD29",
                         "CD56", "O4","CD140a","CD133","GLAST","CD71")

#seu1 <- make_seu(df1, AB_vector)
#seu2 <- make_seu(df2, AB_vector)

seu <- make_seu(df, AB)
# object is scaled in the function


```

Cluster


```{r}

seu <- get_clusters(seu, method = "louvain",
                         df_input = df,
                         k = 40,
                         resolution = 1.2,
                         plots = TRUE,
                         save_plots = FALSE)

DimPlot(seu, raster = FALSE, group.by = "seurat_clusters", label = TRUE)


```


```{r}
seu <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/FlowDataFiles/PresortingMay10June10/NewDataannaote.14122022.Rds")
```



Now annotate the cell types using:
1.Visualization of heatmaps 
2. correlation predictions
3. RandomForest
4. Seurat transfer


Visualize expression

```{r}
AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")
Idents(seu) <- "seurat_clusters"
for (i in AB) {
  print(FeaturePlot(seu, features = i, min.cutoff = 'q1', max.cutoff = 'q97', label = TRUE, raster = FALSE, slot = "scale.data"))
}


```


Heat map by cluster

```{r}
library(data.table)

plotmean(plot_type = 'heatmap',seu = seu, group = 'seurat_clusters',
         markers = AB, 
               var_names = c(0:29), slot = 'scale.data', xlab = "Cluster",
               ylab = "Markers")
```

Correlation predictions and summary bar charts

```{r}
# correlation predictions
reference_data <- read.csv(reference_path <- "/Users/rhalenathomas/GITHUB/CelltypeR/ExampleOuts/FinalReferenceMatrix.csv")
# the reference matrix need to be in the format cell types as rows and markers as columns
# there is a column X with the cell type names
df1 <- reference_data
rownames(df1) <- df1$X # add row names (these are the markers)
df1 <- df1 %>% select(-"X") # remove the column with the marker names
colnames(df1) <- c("Astrocytes","Endothelial","Epithelial","Neurons",
                   "NPC","OPC","Oligo","RadialGlia","StemCell")
df.ref <- as.data.frame(t(df1))
df.ref$X <- rownames(df.ref)

input_df <- read.csv("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/FlowDataFiles/PresortingMay10June10/flowsetMayJune10.csv")

cor <- find_correlation(test = input_df, 
                        reference = df.ref, 
                        min_corr = 0.35, 
                        min_diff = 0.01)

plot_corr(cor, threshold = 0.35, min_cells = 200)

```

Visualize correlation results and get annotation per cluster as well as top 5 most frequent predicted cell types by cluster

```{r}

#seu <- AddMetaData(object=seu, metadata=cor$cell.label, col.name = 'cor.labels')

cor.ann <- get_annotation(seu, seu.cluster = seu$seurat_clusters, 
                          seu.label = seu$cor.labels, top_n = 3, 
                          filter_out = c("Unknown","unknown","Mixed", 
                                         "unassigned","Unassigned"), 
                          Label = "CAM")

# top 5 per groups
t.lables <- as.data.frame(table(seu$seurat_clusters, seu$cor.labels))
  t.lables$Freq <- as.double(t.lables$Freq)
  colnames(t.lables) <- c("Cluster", "Label","Freq")
  top.labs <- t.lables  %>% group_by(Cluster) %>% top_n(5, Freq)
  sort.tops <- top.labs %>% as.data.frame() %>% arrange(desc(Freq))  %>% arrange(Cluster)
  print(sort.tops)
  
#write.csv(sort.tops,"Cor035top5pred.csv")
```

```{r}
# filter cells out that are double labelled and very few 
thresh = 200
freq.cor <- data.frame(table(seu$cor.labels))

keep <- freq.cor %>% filter(Freq > thresh)
# sort by frequency
# sorted_df <- df %>% arrange(desc(Freq))
# alphabetical
cellident <- as.character(keep$Var1)

Idents(seu) <- "cor.labels"
seu.sub <- subset(seu, ident = cellident, invert = FALSE)

plot_lab_clust(seu.sub, seu.sub$seurat_clusters, seu.sub$cor.labels, filter_out = "Unassigned")

```

UMAP with cell types predicted > 200

```{r, fig.width=4}
DimPlot(seu.sub, group.by = "cor.labels", raster = FALSE, label = TRUE)
```


Predictions with RFM

```{r}
# Random Forest predictions

# read in the saved model
rf <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/RFM/RFM_all9hMOAB.RDS")


AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")


rfm.pred <- RFM_predict(seu, rf, markers = AB)
head(rfm.pred)
unique(rfm.pred$Prediction)
seu <- AddMetaData(object=seu, metadata= as.factor(rfm.pred$Prediction), col.name = 'rfm.pred2')
DimPlot(seu, group.by = 'rfm.pred2', raster = FALSE, label = TRUE, repel = TRUE)

plot_lab_clust(seu, seu$seurat_clusters, seu$rfm.pred2, filter_out = c( "Unassigned","Mixed"))

```

Top 5 predictions with RFM and the top prediction per cluster

```{r}
rfm.ann <- get_annotation(seu, seu.cluster = seu$seurat_clusters, 
                          seu.label = seu$rfm.pred2, top_n = 3, 
                          filter_out = c("Unknown","unknown","Mixed", 
                                         "unassigned","Unassigned"), 
                          Label = "RFM")

# top 5 per groups
t.lables <- as.data.frame(table(seu$seurat_clusters, seu$rfm.pred2))
  t.lables$Freq <- as.double(t.lables$Freq)
  colnames(t.lables) <- c("Cluster", "Label","Freq")
  top.labs <- t.lables  %>% group_by(Cluster) %>% top_n(5, Freq)
  sort.tops <- top.labs %>% as.data.frame() %>% arrange(desc(Freq))  %>% arrange(Cluster)
  print(sort.tops)
  
#write.csv(sort.tops,"RFMtop5pred.csv")

```

```{r}
#saveRDS(seu,"/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/SeuNewAIW_labelled.RDS")

seu <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/SeuNewAIW_labelled.RDS")

Idents(seu) <- "seurat_clusters"
seu.sub <- subset(seu, downsample = 5000)

```



Predict cell types with Seurat label transfer

```{r}
# seurat transfer anchor predictions
# Full annotated dataset, this has no unknown cells

seu.r<- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure4/All9MOannaoteAug.RDS") 

Idents(seu.r) <- 'Celltypes'
seu.r <- subset(seu.r, downsample = 5000)

table(seu.r$Celltypes)

DimPlot(seu.r)
#DimPlot(seu, reduction = "pca", group.by = "Sample", raster = FALSE)
AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")
seu.r <- ScaleData(seu.r, features = AB)
seu.r <- RunPCA(seu.r, features = AB, verbose = FALSE, approx = FALSE)



```



Predict with reference data

```{r}
# seurat predict will add the predictions directly 
# make sure to select the labels you want in the reference data seu.r


AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")
seu <- seurat_predict(seu, seu.r, ref_id = 'Celltypes', 
                        refdata = seu.r$Celltypes,
                           down.sample = "none", 
                        markers = AB)


  # find anchors
Idents(seu.r) <- "Celltypes"
anchors <- FindTransferAnchors(reference = seu.r,
                                 query = seu.sub, 
                               features = AB,npcs = 12,
                                 dim= 1:12, n.trees = 25, verbose = FALSE, reduction = "cca"
                               )
  
ancn <- dim(as.data.frame(anchors@anchors))[1]

an <- dim(ancn)[1]

predictions <- TransferData(anchorset = anchors, refdata = seu.r$Celltypes,
                               k.weight = 8)
seu <- AddMetaData(seu, metadata = predictions$predicted.id,
                       col.name = 'seu.pred')




```





```{r}

RidgePlot(seu.r, features = "CD24", slot = 'counts', group.by = 'orig.ident', log = TRUE)

RidgePlot(seu.r, features = "CD24", slot = 'scale.data', group.by = 'orig.ident', log = FALSE)

RidgePlot(seu, features = "CD24", slot = 'counts', group.by = 'orig.ident', log = TRUE)

RidgePlot(seu, features = "CD24", slot = 'scale.data', group.by = 'orig.ident', log = FALSE)

```


Visualization 


```{r}

DoHeatmap(seu, group.by = 'RNA_snn_res.1.2', features = AB, size= 5,slot = "scale.data",
        angle = 90,label = TRUE,
        hjust = 0, group.bar.height = 0.05, disp.max = 2, disp.min = -1.5) + scale_fill_gradientn(colors = c("#154c79", "#eeeee4", "#e28743")) + 
  theme(axis.text.y = element_text(size = 13)) 

```


Feature plots

```{r}

Idents(seu) <- 'RNA_snn_res.1.2'
FeaturePlot(seu, features = AB, slot = 'scale.data',min.cutoff = 'q3', max.cutoff ='q97', ncol = 5, label = TRUE)

for(A in AB){
  print(FeaturePlot(seu, features = A, slot = 'scale.data',min.cutoff = 'q3', max.cutoff ='q97', ncol = 1, label = TRUE))
}

```


Add cell type labels using subtypes from 9000 labels (used to train RF)


```{r}

Idents(seu) <- "RNA_snn_res.1.2"

# labels with the 9000 subset subgroup labels
cluster.ids <- c("mixed","astro1a","astro1b","astro2","RG1a",   # 0-4
                 "Neurons2","RG2","Neurons1a","RG1c","astro1c",  #5-9
                 "Neurons2a","stem-like", "Mixed","RG1b", "astro1d", #10-14
                 "Neurons3a", "OPC", "astro2b","stem-like","astro1e",  #15-19
                 "Neurons3b", "endothelial","astro1f", "Neurons2b","Neurons3b", #20-24
                 "Neurons1b","Neurons3c","RG3","NPC","NPCb", #25-29
                 "astro3","astro-m","epithelial","oligodendrocytes", "astro-m",
                 "RG/astro2")

names(cluster.ids) <- levels(seu)
seu <- RenameIdents(seu, cluster.ids)
seu$labels1 <- Idents(seu)

Idents(seu) <- "RNA_snn_res.1.2"
# combine same 
cluster.ids <- c("Mixed","Astrocytes 1","Radial Glia 3","Astrocytes 2","Radial Glia 1",   # 0-4
                 "Neurons 2","Radial Glia 2","Neurons 1","Radial Glia 2","Astrocytes 1",  #5-9
                 "Neurons 2","Stem-like", "Mixed","Radial Glia 1", "Astrocytes 1", #10-14
                 "Neurons 3", "OPC", "Astrocytes 2","Stem-like","Astrocytes 1",  #15-19
                 "Neurons 3", "Endothelial","Astrocytes 1", "Neurons 2","Neurons 3", #20-24
                 "Neurons 1","Neurons 3","Radial Glia 3","NPC","NPC", #25-29
                 "Astrocytes 3","Astrocytes mature","Epithelial","Oligodendrocytes", "Astrocytes mature",
                 "Glia")

# combine same 
names(cluster.ids) <- levels(seu)
seu <- RenameIdents(seu, cluster.ids)
seu$subtypes <- Idents(seu)
DimPlot(seu, reduction = "umap", label = TRUE, group.by = 'subtypes', repel = TRUE) +
  ggplot2::theme(legend.position = "none")

DimPlot(seu, reduction = "umap", label = TRUE, group.by = 'subtypes', repel = TRUE)


```

```{r}

DoHeatmap(seu, group.by = 'subtypes', features = AB, size= 5,slot = "scale.data",
        angle = 90,label = TRUE,
        hjust = 0, group.bar.height = 0.05, disp.max = 2, disp.min = -1.5) + scale_fill_gradientn(colors = c("#154c79", "#eeeee4", "#e28743")) + 
  theme(axis.text.y = element_text(size = 13)) 

```

Labels with groups matching for proportions

```{r}

Idents(seu) <- "RNA_snn_res.1.2"

# main group labels for proportions

cluster.ids <- c("Mixed","Astrocytes 1","Radial Glia 1","Astrocytes 2","Radial Glia 1",   # 0-4
                 "Neurons 2","Radial Glia 2","Neurons 1","Radial Glia 2","Astrocytes 1",  #5-9
                 "Neurons 2","Stem-like", "Mixed","Radial Glia 1", "Astrocytes 1", #10-14
                 "Neurons 1", "OPC", "Astrocytes 2","Stem-like","Astrocytes 1",  #15-19
                 "Neurons 1", "Endothelial","Astrocytes 1", "Neurons 2","Neurons 2", #20-24
                 "Neurons 1","Neurons 2","Radial Glia 1","NPC","NPC", #25-29
                 "Astrocytes 1","Astrocytes 2","Epithelial","Oligodendrocytes", "Astrocytes 2",
                 "Glia")

names(cluster.ids) <- levels(seu)
seu <- RenameIdents(seu, cluster.ids)
seu$Cell_types <- Idents(seu)

DimPlot(seu, reduction = "umap", label = TRUE, group.by = 'Cell_types', repel = TRUE) +
  ggplot2::theme(legend.position = "none")

DimPlot(seu, reduction = "umap", label = TRUE, group.by = 'Cell_types', repel = TRUE)


DimPlot(seu, group.by = 'RNA_snn_res.1.2', label = TRUE)

```


```{r}

saveRDS(seu, paste(output_path, "NewDataannaote.14122022.Rds"))


```

Heatmaps

```{r}
DoHeatmap(seu, group.by = 'Cell_types', features = AB, size= 5,slot = "scale.data",
        angle = 90,label = TRUE,
        hjust = 0, group.bar.height = 0.05, disp.max = 2, disp.min = -1.5) + scale_fill_gradientn(colors = c("#154c79", "#eeeee4", "#e28743")) + 
  theme(axis.text.y = element_text(size = 13)) 

```


Cell Types for figures

```{r}

Idents(seu) <- "RNA_snn_res.1.2"

cluster.ids <- c("Mixed","Astrocytes 1","Radial Glia 1","Astrocytes 2","Radial Glia 1",   # 0-4
                 "Neurons 2","Radial Glia 2","Neurons 1","Radial Glia 2","Astrocytes 1",  #5-9
                 "Neurons 2","Epithelial", "Neurons 2","Radial Glia 1", "Astrocytes 1", #10-14
                 "Neurons 1", "OPC", "Astrocytes 2","Stem cell like","Astrocytes 1",  #15-19
                 "Neurons 1", "Endothelial","Astrocytes 1", "Neurons 2","Neurons 2", #20-24
                 "Neurons 1","Neurons 2","Radial Glia 1","NPC","NPC", #25-29
                 "Astrocytes 1","Astrocytes 2","Epithelial","Oligodendrocytes", "Astrocytes 2",
                 "Glia")

names(cluster.ids) <- levels(seu)
seu <- RenameIdents(seu, cluster.ids)
seu$Cell_types <- Idents(seu)


# change the order of the cell types on the legend of the umap
cell.type.order <- c("Astrocytes 1", "Astrocytes 2","Radial Glia 1","Radial Glia 2",
                     "Epithelial","Endothelial","NPC","Neurons 1","Neurons 2",
                     "Oligodendrocytes","OPC","Stem cell like","Glia","Mixed")
cell.type.order <- rev(cell.type.order)

# colour order to match cell type order
clust.colours <- c("chocolate1","orange","lightsalmon", "pink",
                   "steelblue3","deepskyblue","plum3","purple","orchid2",
                   "seagreen3","green","tomato3","burlywood3","grey90","lemonchiffon3","yellow")

Idents <- 'Cell_types'
DimPlot(seu, order = cell.type.order, cols = clust.colours, shuffle = TRUE, raster=FALSE,pt.size = 0.1, label = FALSE, label.size = 6) +
  theme(legend.text = element_text(size=16), axis.title.y = element_text(size=16), 
        axis.title.x = element_text(size=16), axis.text.y = element_text(size =16),
        axis.text.x = element_text(size =16))





```







