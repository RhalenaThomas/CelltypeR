---
title: "May 10th and June 10th new hMOs"
output: html_notebook
---

Set up the workspace

```{r}

require(tidyverse)
require(CelltypeR)
require(Seurat)

```

Preprocessing hMO datasets.  Live single cells gated in FlowJo

Read in fsc files


```{r}
# input path is the pathway to the folder with the data

input_path <- "/Users/rhalenathomas/GITHUB/CelltypeR/Data/MayJune2022/"
flowset <- fsc_to_fs(input_path, downsample = "none")


library(flowWorkspace)  # this library has the function "sampleNames"
sampleNames(flowset)

```


2. Make flowset object
- rename for with shorter names
- the data are from two experiments.  The May experiment has two different batches, two replicates each.  The June experiment has 1 batch and three replicates. 

```{r}
# rename samples 
sampleNames(flowset) <- c("M10_A","M10_B","M10_C","M10_D",
                           "J10_A", "J10_B", "J10_C")
sampleNames(flowset)

```


Check the data object


```{r}
#### need to change this function to detect peaks or at least have the user add the column number
### check the density plots above to see which have peaks

plotdensity_flowset(flowset)
flowset_biexp <- harmonize(flowset, processing = 'biexp')

plotdensity_flowset(flowset_biexp)


```
Note the ssc-h values are very different between May and June.  These value are not used in the clustering.


```{r}

#### need to change this function to detect peaks or at least have the user add the column number
### check the density plots above to see which have peaks check in plots above
### this dataset has only one peak in the data

flowset_align <- harmonize(flowset, processing = 'align', 
                           two_peaks = c(1),
                       one_peak = c(2:20), threshold = 0.01)

flowset_retro <- harmonize(flowset, processing = 'retro', 
                           two_peaks = c(1),
                       one_peak = c(2:20), threshold = 0.01)


```


Create the data frame and save for later

```{r}
df <- flowset_to_csv(flowset_retro)

head(df)
summary(df)

write.csv(df, "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/FlowsetAug30.csv")



```




Now create the Seurat object

```{r}
AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")

seu <- make_seu(df, AB_vector = AB)

DimPlot(seu, raster = FALSE, group.by = "Sample", reduction = "pca")
VlnPlot(seu, group.by = "Sample", features = c("CD24","CD56"))
seu <- RunUMAP(seu, n.neighbors = 60, reduction = "pca", features = AB)

DimPlot(seu, raster = FALSE, group.by = "Sample", reduction = "umap")






```

```{r}
table(seu$Sample)

```


```{r}
saveRDS(seu, "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/AIWallcells.RDS")

seu <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/AIWallcells.RDS")

```



Cluster


```{r}

seu <- get_clusters(seu, method = "louvain",
                         df_input = df,
                         k = 60,
                         resolution = 0.8,
                         plots = FALSE,
                         save_plots = FALSE)

DimPlot(seu, raster = FALSE, label = TRUE)


```
```{r}
table(seu$Sample)
```



```{r}
seu <- FindClusters(seu, resolution = c(1,1.2))

DimPlot(seu, label = TRUE, raster = FALSE)


```


```{r}
library(clustree)
clustree(seu, prefix = "RNA_snn_res.")

```




Now annotate the cell types using:
1.Visualization of heatmaps 
2. correlation predictions
3. RandomForest
4. Seurat transfer


Visualize expression

```{r}
AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")
Idents(seu) <- "RNA_snn_res.1.2"
for (i in AB) {
  print(FeaturePlot(seu, features = i, min.cutoff = 'q1', max.cutoff = 'q97', label = TRUE, raster = FALSE, slot = "scale.data"))
}


```



Heat map by cluster

```{r}
library(data.table)
length(unique(seu$seurat_clusters))
plotmean(plot_type = 'heatmap',seu = seu, group = 'seurat_clusters',
         markers = AB, 
               var_names = c(0:28), slot = 'scale.data', xlab = "Cluster",
               ylab = "Markers")
```

Correlation predictions and summary bar charts

```{r}
# correlation predictions
reference_data <- read.csv(reference_path <- "/Users/rhalenathomas/GITHUB/CelltypeR/ExampleOuts/FinalReferenceMatrix.csv")
# the reference matrix need to be in the format cell types as rows and markers as columns
# there is a column X with the cell type names
df1 <- reference_data
rownames(df1) <- df1$X # add row names (these are the markers)
df1 <- df1 %>% select(-"X") # remove the column with the marker names
colnames(df1) <- c("Astrocytes","Endothelial","Epithelial","Neurons",
                   "NPC","OPC","Oligo","RadialGlia","StemCell")
df.ref <- as.data.frame(t(df1))
df.ref$X <- rownames(df.ref)

input_df <- read.csv("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/FlowDataFiles/PresortingMay10June10/flowsetMayJune10.csv")

cor <- find_correlation(test = input_df, 
                        reference = df.ref, 
                        min_corr = 0.35, 
                        min_diff = 0.01)

plot_corr(cor, threshold = 0.35, min_cells = 200)

```

Visualize correlation results and get annotation per cluster as well as top 5 most frequent predicted cell types by cluster

```{r}

cor <- read.csv("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/Cor3501Aug30.csv")

seu <- AddMetaData(object=seu, metadata=cor$cell.label, col.name = 'cor.labels')
cor.ann <- get_annotation(seu, seu.cluster = seu$RNA_snn_res.1.2, 
                          seu.label = seu$cor.labels, top_n = 3, 
                          filter_out = c("Unknown","unknown","Mixed", 
                                         "unassigned","Unassigned"), 
                          Label = "CAM")

# top 5 per groups
t.lables <- as.data.frame(table(seu$RNA_snn_res.1.2, seu$cor.labels))
  t.lables$Freq <- as.double(t.lables$Freq)
  colnames(t.lables) <- c("Cluster", "Label","Freq")
  top.labs <- t.lables  %>% group_by(Cluster) %>% top_n(5, Freq)
  sort.tops <- top.labs %>% as.data.frame() %>% arrange(desc(Freq))  %>% arrange(Cluster)
  print(sort.tops)
  
#write.csv(sort.tops,"Cor035top5pred.csv")
#cor.pred.top5 <- read.csv("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/Cor035top5pred.csv")
  
```

```{r}
# filter cells out that are double labelled and very few 
thresh = 200
freq.cor <- data.frame(table(seu$cor.labels))

keep <- freq.cor %>% filter(Freq > thresh)
# sort by frequency
# sorted_df <- df %>% arrange(desc(Freq))
# alphabetical
cellident <- as.character(keep$Var1)

Idents(seu) <- "cor.labels"
seu.sub <- subset(seu, ident = cellident, invert = FALSE)

plot_lab_clust(seu.sub, seu.sub$seurat_clusters, seu.sub$cor.labels, filter_out = "Unassigned")

```

UMAP with cell types predicted > 200

```{r, fig.width=4}
DimPlot(seu.sub, group.by = "cor.labels", raster = FALSE, label = TRUE)
```


Predictions with RFM

```{r}
# Random Forest predictions

# read in the saved model
rf <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/RFM/RFM_all9hMOAB.RDS")


AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")


rfm.pred <- RFM_predict(seu, rf)
head(rfm.pred)
unique(rfm.pred$Prediction)
seu <- AddMetaData(object=seu, metadata= as.factor(rfm.pred$Prediction), col.name = 'rfm.pred2')
DimPlot(seu, group.by = 'rfm.pred2', raster = FALSE, label = TRUE, repel = TRUE)

plot_lab_clust(seu, seu$seurat_clusters, seu$rfm.pred2, filter_out = c( "Unassigned","Mixed"))

```

Top 5 predictions with RFM and the top prediction per cluster

```{r}

rfm.ann <- get_annotation(seu, seu.cluster = seu$RNA_snn_res.1.2, 
                          seu.label = seu$rfm.pred2, top_n = 3, 
                          filter_out = c("Unknown","unknown","Mixed", 
                                         "unassigned","Unassigned"), 
                          Label = "RFM")

# top 5 per groups
t.lables <- as.data.frame(table(seu$RNA_snn_res.1.2, seu$rfm.pred2))
  t.lables$Freq <- as.double(t.lables$Freq)
  colnames(t.lables) <- c("Cluster", "Label","Freq")
  top.labs <- t.lables  %>% group_by(Cluster) %>% top_n(5, Freq)
  sort.tops <- top.labs %>% as.data.frame() %>% arrange(desc(Freq))  %>% arrange(Cluster)
  print(sort.tops)
  
write.csv(sort.tops,"/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/RFMtop5predAug30.csv")
  
#rfm.pred.top5 <- read.csv("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/RFMtop5predAug30.csv")

```

```{r, fig.width=4}
DimPlot(seu, group.by = "rfm.pred2", raster = FALSE, label = TRUE)
```




Predict cell types with Seurat label transfer

```{r}
# seurat transfer anchor predictions
# Full annotated dataset, this has no unknown cells

seu.r<- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure4/All9MOannaoteAug.RDS") 

# take the AIW hMOs

Idents(seu.r) <- "Sample"
levels(seu.r)
seu.r <- subset(seu.r, idents = c("AIW002_0306", "AIW002_0317A", "AIW002_0317B"))
seu.aiw <- seu.r

DimPlot(seu.aiw, group.by = "Celltypes")
table(seu.aiw$Celltypes)



#DimPlot(seu, reduction = "pca", group.by = "Sample", raster = FALSE)
AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")
Idents(seu.r) <- "Celltypes"
seu.r <- subset(seu.r, downsample = 1000)

seu.r <- ScaleData(seu.r, features = AB)
seu.r <- RunPCA(seu.r, features = AB, verbose = FALSE, approx = FALSE)

```



Predict with reference data

```{r}
# seurat predict will add the predictions directly 
# make sure to select the labels you want in the reference data seu.r


AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")
seu <- seurat_predict(seu, seu.r, ref_id = 'Celltypes', 
                        refdata = seu.r$Celltypes,
                           down.sample = "none", 
                        markers = AB, kfilter = 50)


seu.ann <- get_annotation(seu, seu.cluster = seu$RNA_snn_res.1.2, 
                          seu.label = seu$seu.pred, top_n = 1, 
                          filter_out = c("Unknown","unknown","Mixed", 
                                         "unassigned","Unassigned"), 
                          Label = "seu")

# top 5 per groups
t.lables <- as.data.frame(table(seu$RNA_snn_res.1.2, seu$seu.pred))
  t.lables$Freq <- as.double(t.lables$Freq)
  colnames(t.lables) <- c("Cluster", "Label","Freq")
  top.labs <- t.lables  %>% group_by(Cluster) %>% top_n(5, Freq)
  sort.tops <- top.labs %>% as.data.frame() %>% arrange(desc(Freq))  %>% arrange(Cluster)
  print(sort.tops)





```

```{r}
DimPlot(seu, label = TRUE, raster = FALSE, group.by = "seu.pred")
```



Make a table with the top predictions per cell type from 3 prediction methods

```{r}
an.list <- list(cor.ann, rfm.ann, seu.ann)
df.an <- annotate_df(an.list)
df.an
setwd("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/")
write.csv(df.an, "annotationPredsTop1Aug30.csv")

```


```{r}
DimPlot(seu, group.by = "RNA_snn_res.0.8", label = TRUE, raster = FALSE)
```


```{r}
unique(seu.r$Celltypes)
```





Annotated clusters of two new AIW002-02 hMO batches

```{r, fig.width= 10}

# all cluster named separately
cluster.ids <- c("Glial-lineage","Astro2a","Astro1a","Neural-lineage","RG1.1",   # 0-4
                 "Epithelial","Neurons1a","Neurons1b","RG1","Neurons1c",  #5-9
                 "OPC","RG2","Astro1a", "Neurons2d","Endothelial", #10-14
                 "RG1.2", "RG1a", "Glial-lineage","NPCa","OPC-like",  #15-19
                 "Neurons2a", "stemlike","Neurons2b", "Astro2b", "NPCb", #20-24
                 "Neurons2c","RG3","Astro2c","oligo"
                 )


seu <- annotate(seu, annotations = cluster.ids, to_label = "RNA_snn_res.1.2", 
                annotation_name = "Celltypes1")

DimPlot(seu, label = TRUE, raster = FALSE, label.size = 6)

# decided RG group by heatmap 


# group same together 
cluster.ids <- c("Glia-lineage","Astrocytes 2","Astrocytes 1","Neural-lineage","Radial Glia 1",   # 0-4
                 "Epithelial","Neurons 1","Neurons 1","Radial Glia 1","Neurons 1",  #5-9
                 "OPC","Radial Glia 2","Astrocytes 1", "Neurons 2","Endothelial", #10-14
                 "Radial Glia 1", "Radial Glia 1a", "Glia-lineage","NPC","OPC-like",  #15-19
                 "Neurons 2", "Stem cell like","Neurons 2", "Astrocytes 2", "NPC", #20-24
                 "Neurons 2","Radial Glia 3","Astrocytes 2","Oligodendrocytes"
                 )

seu <- annotate(seu, annotations = cluster.ids, to_label = "RNA_snn_res.1.2", 
                annotation_name = "Celltypes")

DimPlot(seu, label = TRUE, raster = FALSE, label.size = 6)

cell.order <- c("Astrocytes 1", "Astrocytes 2",
                     "Radial Glia 1","Radial Glia 1a","Radial Glia 2",
                     "Radial Glia 3","Glia-lineage",
                     "Epithelial","Endothelial",
                     "Neurons 1","Neurons 2","NPC","Neural-lineage",
                     "Oligodendrocytes","OPC","OPC-like",
                     "Stem cell like")

clust.colours <- c("chocolate2",# Astrocytes 1
                   "darkorange", # Astrocytes 2
                   "pink", # RG1
                   "deeppink",# RG1a
                   "plum1", #RG2
                   "lightpink3",# RG3
                   "mistyrose2", # Glia-lineage
                   "steelblue3",# epithelial
                   "deepskyblue", # endothelial
                   "mediumpurple1",# neurons 1
                   "purple",# Neurons2
                   "plum3", # NPC
                   "mediumslateblue", # Neural lineage
                   "seagreen3",#Oligo
                   "olivedrab4", # OPC
                   "darkseagreen3",#OPC like
                   "tomato3",# stem like
                   "burlywood3", #extra
                   )

DimPlot(seu, cols = clust.colours, shuffle = TRUE, 
        raster=FALSE, pt.size = 0.1, label = TRUE, 
        group.by = 'Celltypes',
        order = rev(cell.order))



```

save the plot
```{r}


table(seu$Celltypes)


setwd("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/")
pdf("UMAP.all.cells2.pdf",width = 9, height = 4.5)
DimPlot(seu, cols = clust.colours, shuffle = TRUE, 
        raster=FALSE, pt.size = 0.001, label = FALSE, 
        group.by = 'Celltypes',
        order = rev(cell.order)) +
theme(legend.text = element_text(size=15), axis.title.y = element_text(size=15), 
         axis.title.x = element_text(size=15), axis.text.y = element_text(size =15),
        axis.text.x = element_text(size =15))
dev.off()


```






```{r}
Idents(seu) <- "Celltypes"

cells <- levels(seu)

plotmean(plot_type = 'heatmap',seu = seu, group = 'Celltypes',
         markers = AB, slot = 'scale.data', xlab = "Celltypes",var_names = cells,
               ylab = "Markers")

```


Add batch annotations

```{r}
Idents(seu) <- "Sample"
levels(seu)

batch <- c("C","C","D","D","C","C","C")
seu <- annotate(seu, annotations = batch, 
                  to_label= "Sample", 
                  annotation_name = "Batch")

table(seu$Sample, seu$Batch)


```






Combine the two data objects and make the barcharts

```{r}

seu.aiw$orig.ident <- "AandB"

seu$orig.ident <- "CandD"

seu.all <- merge(seu.aiw, y = seu, project = "AIW002all.batches")




```


```{r}
saveRDS(seu.all, "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/CombinedABCD.RDS")

seu.all <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/CombinedABCD.RDS")

```




```{r}
VlnPlot(seu.all, features = "CD24", group.by = "Batch")
```


```{r}
table(seu.all$Batch, seu.all$Celltypes)
```

Make a barchart of the proportion of cell types

```{r}

# cell order and clust.colours defined above)
seu.all$Celltypes <- factor(seu.all$Celltypes, levels = c("Astrocytes 1", "Astrocytes 2",
                     "Radial Glia 1","Radial Glia 1a","Radial Glia 2",
                     "Radial Glia 3","Glia-lineage",
                     "Epithelial","Endothelial",
                     "Neurons 1","Neurons 2","NPC","Neural-lineage",
                     "Oligodendrocytes","OPC","OPC-like",
                     "Stem cell like"))


proportionplots(seu.all, seu.var = seu.all$Batch, seu.lable = seu.all$Celltypes, groups = "AIW002 Batch", my_colours = clust.colours)

```

save the plot
```{r}
setwd("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/")
pdf("PercentCelltypesBatch.pdf", width = 5, height = 4)
proportionplots(seu.all, seu.var = seu.all$Batch, seu.lable = seu.all$Celltypes, groups = "AIW002 Batch", my_colours = clust.colours)
dev.off()


```

Proportionality tests

```{r}

library(scProportionTest)
# create a propotion test object



Idents(seu.all) <- "Celltypes"
prop_test <- sc_utils(seu.all)

# set up the comparison

# need to compare separately
prop_test <- permutation_test(
	prop_test, cluster_identity = "Celltypes",
	sample_1 = "A", sample_2 = "B",
	sample_identity = "Batch"
)

# make the plot
permutation_plot(prop_test)
setwd("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/")
# save the plot 
png("prp.test.batchAvsB.png", width = 600, height = 300)
permutation_plot(prop_test) +  theme(axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),    # Adjust axis title size
  legend.text = element_text(size = 12),   # Adjust legend text size
  legend.title = element_text(size = 14))
dev.off()


# need to compare separately
prop_test <- permutation_test(
	prop_test, cluster_identity = "Celltypes",
	sample_1 = "A", sample_2 = "C",
	sample_identity = "Batch"
)

# make the plot
permutation_plot(prop_test)

# save the plot 
png("prp.test.batchAvsC.png", width = 600, height = 300)
permutation_plot(prop_test) +  theme(axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),    # Adjust axis title size
  legend.text = element_text(size = 12),   # Adjust legend text size
  legend.title = element_text(size = 14))
dev.off()

# need to compare separately
prop_test <- permutation_test(
	prop_test, cluster_identity = "Celltypes",
	sample_1 = "A", sample_2 = "D",
	sample_identity = "Batch"
)

# make the plot
permutation_plot(prop_test)

# save the plot 
png("prp.test.batchAvsD.png", width = 600, height = 300)
permutation_plot(prop_test) +  theme(axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),    # Adjust axis title size
  legend.text = element_text(size = 12),   # Adjust legend text size
  legend.title = element_text(size = 14))
dev.off()

# need to compare separately
prop_test <- permutation_test(
	prop_test, cluster_identity = "Celltypes",
	sample_1 = "B", sample_2 = "C",
	sample_identity = "Batch"
)

# make the plot
permutation_plot(prop_test)

# save the plot 
png("prp.test.batchBvsC.png", width = 600, height = 300)
permutation_plot(prop_test) +  theme(axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),    # Adjust axis title size
  legend.text = element_text(size = 12),   # Adjust legend text size
  legend.title = element_text(size = 14))
dev.off()

# need to compare separately
prop_test <- permutation_test(
	prop_test, cluster_identity = "Celltypes",
	sample_1 = "B", sample_2 = "D",
	sample_identity = "Batch"
)

# make the plot
permutation_plot(prop_test)

# save the plot 
png("prp.test.batchBvsD.png", width = 600, height = 300)
permutation_plot(prop_test) +  theme(axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),    # Adjust axis title size
  legend.text = element_text(size = 12),   # Adjust legend text size
  legend.title = element_text(size = 14))
dev.off()


# need to compare separately
prop_test <- permutation_test(
	prop_test, cluster_identity = "Celltypes",
	sample_1 = "C", sample_2 = "D",
	sample_identity = "Batch"
)

# make the plot
permutation_plot(prop_test)

# save the plot 
png("prp.test.batchCvsD.png", width = 600, height = 300)
permutation_plot(prop_test) +  theme(axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.title = element_text(size = 14),    # Adjust axis title size
  legend.text = element_text(size = 12),   # Adjust legend text size
  legend.title = element_text(size = 14))
dev.off()



```


