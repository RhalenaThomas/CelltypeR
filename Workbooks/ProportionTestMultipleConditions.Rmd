---
title: "R Notebook"
output: html_notebook
---


```{r}
library(speckle)
library(speckle)
library(limma)
library(ggplot2)

```


```{r}


# get the seurat object
# Four AIW batchs shown in Figure 5B

seu <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure5/CombinedABCD.RDS")

colnames(seu@meta.data)
unique(seu$Sample)
unique(seu$orig.ident)
unique(seu$Batch)
unique(seu$Celltypes) # lables in the figure 

# Run propeller testing for cell type proportion differences between the two 
# groups
ANOVA <- propeller(x = seu, clusters = seu$Celltypes, sample = seu$Sample, 
group = seu$Batch, transform="asin")

ANOVA2 <- propeller(x = seu, clusters = seu$Celltypes, sample = seu$Sample, 
group = seu$Batch)

ANOVA
ANOVA2

# There are two transformation options to be used, the transformed values are what are compared.  They give very different results in this case

```

See the results with the arcsin transformation

```{r}
Compare4batches <- ANOVA[,7:8]
print(Compare4batches)
```
Now we can see that Stem cells, Astrocytes 2, Radial Glia 3 are significant with adjusted p value.



Visualize the results compare across all 4 samples.

```{r}
# Assuming `ANOVA` is your data frame containing the results
# Replace `ANOVA` with your actual data frame name

# Select relevant columns and add a column for the Cell Type based on row names
plot_data <- ANOVA[, c("BaselineProp", "PropMean.A", "PropMean.B", "PropMean.C", "PropMean.D")]
plot_data$Cell_Type <- rownames(plot_data)

# Convert columns to numeric
numeric_columns <- c("BaselineProp", "PropMean.A", "PropMean.B", "PropMean.C", "PropMean.D")
plot_data[, numeric_columns] <- lapply(plot_data[, numeric_columns], as.numeric)

# Calculate the differences between Baseline and each PropMean
plot_data_diff <- plot_data[, -6] - plot_data$BaselineProp

# Create a new data frame with Cell Type and differences for each PropMean
diff_data <- data.frame(Cell_Type = plot_data$Cell_Type, plot_data_diff)

# Melt the data for plotting
diff_data_long <- tidyr::gather(diff_data, key = "Variable", value = "Difference", -Cell_Type)

# Add FDR values to the melted data
diff_data_long$FDR <- ANOVA$FDR[match(diff_data_long$Cell_Type, rownames(ANOVA))]

# Plotting using ggplot

ggplot(diff_data_long, aes(x = Difference, y = Cell_Type, color = Variable)) +
  geom_point(size = 3, alpha = 0.7) +  # Adjust alpha here
  geom_text(data = subset(diff_data_long, FDR < 0.05), 
            aes(x = 0.1, label = "*"), 
            hjust = -0.2, vjust = 0.5, size = 4, color = "black") +  # Add black star at x = 0.1 if FDR < 0.05
  labs(title = "Difference in Proportions from Baseline",
       x = "Difference from Baseline",
       y = "Cell Type",
       color = "Variable") +
  theme_minimal()

### don't show baseline

ggplot(diff_data_long, aes(x = Difference, y = Cell_Type, color = Variable)) +
  geom_point(data = subset(diff_data_long, Variable != "BaselineProp"), 
             size = 3, alpha = 0.7) +  # Exclude baseline from geom_point
  geom_text(data = subset(diff_data_long, FDR < 0.05), 
            aes(x = 0.1, label = "*"), 
            hjust = -0.2, vjust = 0.5, size = 4, color = "black") +  # Add black star at x = 0.1 if FDR < 0.05
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray") +  # Add vertical line at x = 0
  labs(title = "Difference in Proportions from Baseline",
       x = "Difference from Baseline",
       y = "Cell Type",
       color = "Variable") +
  theme_minimal()



```
Stars are placed where differences are signficant.




# Compare pairwise four different Batches using propellar

```{r}
library(Seurat)
Idents(seu) <- "Batch"
AandB <- subset(seu, idents = c("A","B"))
levels(AandB)

# proportion test

prpAvsBarc <- propeller(x = AandB, clusters = AandB$Celltypes, sample = AandB$Sample, 
group = AandB$Batch, transform="asin")

prpAvsBarc

prpAvsB <- propeller(x = AandB, clusters = AandB$Celltypes, sample = AandB$Sample, 
group = AandB$Batch)
prpAvsB

# no differences between A and B


```



C and D

```{r}
Idents(seu) <- "Batch"
CandD <- subset(seu, idents = c("C","D"))
levels(CandD)

# proportion test

propeller(x = CandD, clusters = CandD$Celltypes, sample = CandD$Sample, 
group = CandD$Batch, transform="asin")

propeller(x = CandD, clusters = CandD$Celltypes, sample = CandD$Sample, 
group = CandD$Batch)

# no significant differences between C and D

```

A vs C

```{r}
Idents(seu) <- "Batch"
AandC <- subset(seu, idents = c("A","C"))
levels(AandC)

# proportion test

propeller(x = AandC, clusters = AandC$Celltypes, sample = AandC$Sample, 
group = AandC$Batch, transform="asin")

propeller(x = AandC, clusters = AandC$Celltypes, sample = AandC$Sample, 
group = AandC$Batch)

# not significant differences between Stem cell like and Astrocytes 2 are significantly different FDR by arcsin
# by log transform Stem cell like and Astrocytes 2 and oligodendrocytes



```

A vs D

```{r}
Idents(seu) <- "Batch"
AandD <- subset(seu, idents = c("A","D"))
levels(AandD)

# proportion test

propeller(x = AandD, clusters = AandD$Celltypes, sample = AandD$Sample, 
group = AandD$Batch, transform="asin")

propeller(x = AandD, clusters = AandD$Celltypes, sample = AandD$Sample, 
group = AandD$Batch)

# no significant differences A and D

```

B vs C

```{r}
Idents(seu) <- "Batch"
BandC <- subset(seu, idents = c("B","C"))
levels(BandC)

# proportion test

propeller(x = BandC, clusters = BandC$Celltypes, sample = BandC$Sample, 
group = BandC$Batch, transform="asin")

propeller(x = BandC, clusters = BandC$Celltypes, sample = BandC$Sample, 
group = BandC$Batch)

# not significant differences between Stem cell like and Astrocytes 2 and Radial Glia 3 are significantly different FDR by arcsin
# by log transform Stem cell like and Astrocytes 2 and oligodendrocytes and Radial Glia 3


```



```{r}
Idents(seu) <- "Batch"
BandD <- subset(seu, idents = c("B","D"))
levels(BandD)

# proportion test

propeller(x = BandD, clusters = BandD$Celltypes, sample = BandD$Sample, 
group = BandD$Batch, transform="asin")

propeller(x = BandD, clusters = BandD$Celltypes, sample = BandD$Sample, 
group = BandD$Batch)

# stem cells are different by log transform and no difference by arcin
# 

```


Check Figure 4 contrasts

```{r}
# read in the figure 4 data
# read in the data to analyze 
pathway <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure4/"
seuAll <- readRDS(paste(pathway,"All9MOannaoteAug.RDS", sep = ""))

colnames(seuAll@meta.data)

```

9 MBO data 3 genotypes

```{r}
propeller(x = seuAll, clusters = seuAll$Celltypes, sample = seuAll$Sample, 
group = seuAll$IPSC, transform="asin")

propeller(x = seuAll, clusters = seuAll$Celltypes, sample = seuAll$Sample, 
group = seuAll$IPSC)

# Plot cell type proportions
plotCellTypeProps(x = seuAll, clusters = seuAll$Celltypes, sample = seuAll$Sample)

# no signficant difference in asin and only Neurons 2 with log


```


Pairwise - first AIW002 vs 3450 and AJG001C as in Figure 4

```{r}
propeller(x = seuAll, clusters = seuAll$Celltypes, sample = seuAll$Sample, 
group = seuAll$ipsc, transform="asin")

propeller(x = seuAll, clusters = seuAll$Celltypes, sample = seuAll$Sample, 
group = seuAll$ipsc)


# Neurons 2 and oligodendrocytes signifiantly different by log transform
# only Neurons 2 by arcsin






```


Subset compare each pair AIW002 vs AJG001C

```{r}


Idents(seuAll) <- "IPSC"
levels(seuAll)
AIWvsAJG <- subset(seuAll, idents = c("AIW002","AJG001"))
levels(AIWvsAJG)

# proportion test

propeller(x = AIWvsAJG, clusters = AIWvsAJG$Celltypes, sample = AIWvsAJG$Sample, 
group = AIWvsAJG$Batch, transform="asin")

propeller(x = AIWvsAJG, clusters = AIWvsAJG$Celltypes, sample = AIWvsAJG$Sample, 
group = AIWvsAJG$Batch)

# no significant differences


```

AIW002 vs 3450

```{r}
Idents(seuAll) <- "IPSC"
levels(seuAll)
AIWvs3450 <- subset(seuAll, idents = c("AIW002","3450"))
levels(AIWvs3450)

# proportion test

propeller(x = AIWvs3450, clusters = AIWvs3450$Celltypes, sample = AIWvs3450$Sample, 
group = AIWvs3450$Batch, transform="asin")

propeller(x = AIWvs3450, clusters = AIWvs3450$Celltypes, sample = AIWvs3450$Sample, 
group = AIWvs3450$Batch)

# no significant differences

```

AJG001C vs 3450

```{r}
Idents(seuAll) <- "IPSC"
levels(seuAll)
AJGvs3450 <- subset(seuAll, idents = c("AJG001","3450"))
levels(AJGvs3450)

# proportion test

propeller(x = AJGvs3450, clusters = AJGvs3450$Celltypes, sample = AJGvs3450$Sample, 
group = AJGvs3450$Batch, transform="asin")

propeller(x = AJGvs3450, clusters = AJGvs3450$Celltypes, sample = AJGvs3450$Sample, 
group = AJGvs3450$Batch)

# no significant differences Neurons 2 almost

```


# Creating a permutation anova test


Original permulation test

```{r}
library(scProportionTest)
# create a propotion test object

Idents(seuAll) <- "Celltypes"
prop_test <- sc_utils(seuAll)

# set up the comparison

# need to compare separately
prop_test <- permutation_test(
	prop_test, cluster_identity = "Celltypes",
	sample_1 = "AIW002", sample_2 = "AJG001",
	sample_identity = "IPSC"
)

# make the plot
permutation_plot(prop_test)

```



permuco library for permutation test applied to single cell data in seurat object
 
```{r}

library(data.table)
library("permuco")


permutation_test_multi <- function(
  sc_utils_obj,
  cluster_identity = "Celltypes",
  sample_identity = "Batch",
  n_permutations = 2000
) {
  ## Prepare data.
  meta_data <- sc_utils_obj@meta_data[
    , c(..sample_identity, ..cluster_identity)
  ]
  
  setnames(
    meta_data,
    old = c(sample_identity, cluster_identity),
    new = c("samples", "clusters")
  )
  
  meta_data[, clusters := as.character(clusters)]
  cluster_cases <- unique(meta_data[["clusters"]])
  
  ## Get observed differences in fraction between all samples
  obs_diff <- meta_data[, .(count = .N), by = .(samples, clusters)]
  obs_diff <- obs_diff[
    CJ(samples = unique(meta_data$samples), clusters = cluster_cases, unique = TRUE),
    on = .(samples, clusters)
  ][
    is.na(count), count := 0
  ][]
  obs_diff[, fraction := count / sum(count), by = samples]
  
  ## Get unique samples
  unique_samples <- unique(obs_diff$samples)
  
  ###  get the F statistic and pvalues and permutation test
  # Initialize an empty list to store results
  results <- list()
  
  # Loop over each unique cluster
  for (cluster in unique(obs_diff$clusters)) {
    # Subset data for the current cluster
    cluster_data <- subset(obs_diff, clusters == cluster)
    
    # Define the formula for ANOVA
    formula <- fraction ~ count
    
    # Perform permutation test using aovperm
    permutation_result <- aovperm(formula, data = cluster_data, type = "permutation")
    
    # Store the result in the list with cluster name as the key
    results[[cluster]] <- permutation_result
  }
  
  # Create an empty data frame to store final results
  results_df <- data.frame(Cluster = character(),
                            stringsAsFactors = FALSE)
  
  # Loop over each unique cluster
  for (i in seq_along(results)) {
    # Extract F-statistic, SS, and p-values
    F_statistics <- results[[i]]$table$F
    SS <- results[[i]]$table$SS[1]  # Extract the first SS value
    parametric_p <- results[[i]]$table$`parametric P(>F)`[1]  # Extract the first p-value
    resample_p <- results[[i]]$table$`resampled P(>F)`[1]  # Extract the resampled p-value
    
    # Extract sample fractions
    cluster_data <- subset(obs_diff, clusters == unique(obs_diff$clusters)[i])
    sample_fractions <- cluster_data$fraction
    
    # Create a new row for the cluster
    new_row <- data.frame(Cluster = rep(unique(obs_diff$clusters)[i], 1),
                          stringsAsFactors = FALSE)
    
    # Add sample fractions to the new row
    for (sample in unique_samples) {
      if (sample %in% cluster_data$samples) {
        new_row[paste0(sample, ".Fraction")] <- sample_fractions[cluster_data$samples == sample]
      } else {
        new_row[paste0(sample, ".Fraction")] <- NA
      }
    }
    
    # Add SS, Parametric P-value, and Resampled P-value to the new row
    new_row$SS <- SS
    new_row$Parametric_Pval <- parametric_p
    new_row$Resample_Pval <- resample_p
    
    # Append the new row to the results data frame
    results_df <- rbind(results_df, new_row)
  }
  
  return(results_df)
}


```

### Apply permuation anova to 3 iPSC lines

```{r}

#library(scProprtionTest)

# must run sc_utils to set up the 
Idents(seuAll) <- "Celltypes"
sc_utils_obj <- sc_utils(seuAll)

multi2 <- permutation_test_multi(
	sc_utils_obj = sc_utils_obj,
	cluster_identity = "Celltypes",
	sample_identity = "IPSC",
	n_permutations = 3000
)

multi2

```


Now make some kind of plot

```{r}
#library(ggplot2)


# Reshape the dataframe to long format
multi_long <- tidyr::pivot_longer(multi, cols = -c(Cluster, SS, Parametric_Pval, Resample_Pval), 
                                  names_to = "Sample", values_to = "Fraction")

# Extract sample names from Sample column
multi_long$Sample <- sub("\\..*", "", multi_long$Sample)

# Create the dot plot
dot_plot <- ggplot(multi_long, aes(x = Fraction, y = Cluster, color = Parametric_Pval < 0.05)) +
  geom_point(size = 3) +  # Plot points
  scale_color_manual(values = c("TRUE" = "red", "FALSE" = "black")) +  # Color dots by significance
  labs(x = "Fraction", y = "Cluster") +  # Add axis labels
  theme_minimal() +  # Set plot theme
  theme(axis.text.y = element_text(size = 8))  # Adjust size of y-axis text

# Display the plot
print(dot_plot)

```


Now run the AIW batches data

```{r}

# set up the data object with sc_utils

#colnames(seu@meta.data)
#library(Seurat)
Idents(seu) <- "Celltypes"
sc_utils_obj <- sc_utils(seu)



multiBatch <- permutation_test_multi(
	sc_utils_obj,
	cluster_identity = "Celltypes",
	sample_identity = "Batch",
	n_permutations = 2000
)

multiBatch



```

Plot results 
Difference from the mean Fractions of cell types for each sample

```{r}
plot_diff <- function(data, title = "Name of plot") {
  # Calculate the mean fraction value across the samples for each cluster
  data_mean <- data %>%
    mutate(Mean_Fraction = rowMeans(select(., ends_with(".Fraction"))))
  
  # Reshape the dataframe to long format
  data_long <- tidyr::pivot_longer(data_mean, cols = -c(Cluster, SS, Parametric_Pval, Resample_Pval, Mean_Fraction), 
                                    names_to = "Sample", values_to = "Difference")
  
  # Extract sample names from Sample column
  data_long$Sample <- sub("\\..*", "", data_long$Sample)
  
  # Create the dot plot
  dot_plot <- ggplot(data_long, aes(x = Difference, y = Cluster, color = Sample, shape = Parametric_Pval <= 0.05)) +
    geom_point(size = 3, stroke = 0.5) +  # Plot points
    scale_color_viridis_d(option = "C") +  # Color dots by sample
      # Set shape of dots based on significance
    labs(x = "Difference from Mean", y = "Cluster") +  # Add axis labels
    theme_minimal() +  # Set plot theme
    theme(axis.text.y = element_text(size = 8)) +  # Adjust size of y-axis text
    guides(shape = guide_legend(title = "Significance")) + # Add legend title for shape
    scale_shape_manual(values = c("TRUE" = 21, "FALSE" = 19), 
                        breaks = c(TRUE, FALSE),
                        labels = c("P value < 0.05", "P value > 0.05"))
  
  return(dot_plot)
}


plot_diff(multiBatch, title = "Compare 4 AIW002 Batches")
plot_diff(multi2, title = "Compare 3 iPSC lines: AIW002, AJG001C, 3450")

```


Plot mean fraction across samples and standard deviation
Signficant contrast are in pink


```{r}
plot_mean_fraction <- function(output_df, title = "Name of plot") {
  # Calculate the mean fraction and standard deviation across samples for each cluster
  output_df <- output_df %>%
    pivot_longer(cols = contains(".Fraction"), names_to = "Sample", values_to = "Fraction") %>%
    group_by(Cluster) %>%
    summarise(Mean_Fraction = mean(Fraction),
              Std_Dev = sd(Fraction),
              P_parametric = min(Parametric_Pval))
  
  # Determine colors based on significance of contrast
  output_df$color <- ifelse(output_df$P_parametric < 0.05, "pink", "grey")
  
  # Plot the mean fraction and standard deviation
  ggplot(output_df, aes(x = Mean_Fraction, y = reorder(Cluster, Mean_Fraction), color = color)) +
    geom_point(size = 3) +  # Plot points with color
    geom_errorbarh(aes(xmin = Mean_Fraction - Std_Dev, xmax = Mean_Fraction + Std_Dev), height = 0) +  # Add error bars
    labs(x = "Mean Fraction", y = "Cluster") +  # Axis labels
    scale_color_identity() +  # Use specified colors
    theme_minimal() +  # Plot theme
    theme(axis.text.y = element_text(size = 8))  + # Adjust y-axis text size
    ggtitle(title)
}

# Example usage:
plot_mean_fraction(multiBatch, "Compare 4 Batches")
plot_mean_fraction(multi2, "Compare 3 control iPSC lines AIW002, AJG001C, 3450")

```

