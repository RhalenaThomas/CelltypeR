---
title: "CelltypeR workflow"
output: html_notebook
---

1. Data preprocessing
a.	Read FlowJo files into R.
b.	Create a data frame with intensity measurements for each marker for all samples within the experiment to be analyzed.  
c.	Harmonize data 
d.	Explore clusters

```{r}
# load necessary libraries 
library(Seurat)
library(dplyr) 
library(ggplot2)
# library(CelltypeR)

```


Read in the flow data
This data should be the gated live cells.  
All samples need to be in one folder.


```{r}

input_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/FlowDataFiles/9MBO"
output_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/"

# 1.a Read in FlowJo Files 

# choose to downsample to 9000 where possible
# check this - I don't think it worked
flowset <- fsc_to_fs(input_path, downsample = 9000)
# down sample can be a number, 'none' or 'min'

# look at file names and rename with shorter sample names

sampleNames(flowset)
sampleNames(flowset) <- sampleNames(flowset) <- c("3450_0306","AIW002_0306","AJG001C_0306","3450_0317A","AIW002_0317A","AJG001C_0317A","3450_0317B","AIW002_0317B","AJG001C_0317B")
sampleNames(flowset)


# if we want to save the flowset object now we can 
# this would be read back in with flowset 
# 



```


Harmonize data to remove batch or technical variation

This requires us to look and see where there are two peaks to align. We need to visualize the peaks of the transformed data before aligning.

```{r}

# we can decided what level of processing to choose with the argument 'processing'
# biexp only applies a biexponential transformation
# align applies biexp transform and then aligns peaks
# retro (default), transforms, aligns and then reverse transforms
flowset_biexp <- harmonize(flowset, processing = 'biexp')
# we can visualize the peaks to see where there are two peaks for alignment

# we need to enter the column index for which peaks to align, the alignment for one or two peaks is not the same. 
#plotdensity_flowset(flowset)
#plotdensity_flowset(flowset_biexp) # to see the peaks

flowset_align <- harmonize(flowset, processing = 'align', 
                           two_peaks = c(7:20),
                       one_peak = c(1:6,21), threshold = 0.01)

flowset_retro <- harmonize(flowset, processing = 'retro', 
                           two_peaks = c(7:20),
                       one_peak = c(1:6,21), threshold = 0.01)

df <- flowset_to_csv(flowset_retro)




```

Now we have made all the different processing of the fsc files.  We can visualize the intensity in cell density plots to see the alignment

```{r}
#plotdensity_flowset(flowset)
plotdensity_flowset(flowset_biexp)
plotdensity_flowset(flowset_align)
#plotdensity_flowset(flowset_retro)


```

Now we will make test out clustering.
For Seurat clustering and Phenograph we will make the Seurat object
Flowsome takes in the dataframe directly.


```{r}

# the function make_seu will take in the df of expression and Antibody/Marker list as a vector and create a seurat object. Values are scaled. Marker expression will be in the "RNA" slot. PCA is calculated using AB vector as the features 

# make sure to always keep the same antibody order or your labels will not be correct


# antibody features in order to appear on the plots
AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")
seu <- make_seu(df, AB_vector = AB)


```
Save dataframe and seurat object for later

```{r}

output_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/"

# to save the df for later
# write.csv(df, "pathway/filename.csv")
#write.csv(df, paste(output_path,"df9000Feb15.csv", sep = ""))
write.csv(df, paste(output_path,"df9000Feb24.csv", sep = ""))
# save the seurat object
saveRDS(seu, paste(output_path,"seu9000Feb24.RDS", sep = ""))



```


Read in the csv of the flow files processed and the seurat object

```{r}
df.input <- read.csv("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/df9000Feb24.csv")

seu <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/seu9000Feb24.RDS")


```

Test Flowsom

```{r}

output_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/exp_clusters/flow/"


flow.test <- explore_param(seu, #for phenograph and louvain only
                          cluster_method = 'flowsom', #take 1 cluster method
                          df_input= df.input, #needed  if input "flowsom"
                          flow_k = c(3,5,10,20), #k for flowsom
                          pheno_lou_kn = NULL, #kn for phenograph or louvain
                          lou_resolution = NULL, #resolution for louvain
                          run.plot = TRUE, #print if run
                          run.stats = TRUE, #print and return if run
                          save_to = NULL)





```

See Flowsom stats plots

```{r}
p1 <- stats_plot(stats_ls = flow.test,
                       save_to = output_path,
                       clust_method = "flowsom") 

```

Phenograph

```{r}

output_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/exp_clusters/pheno/"

pheno.test <-  explore_param(seu, #for phenograph and louvain only
                          cluster_method = 'phenograph', #take 1 cluster method
                          df_input= df.input, #needed  if input "flowsom"
                          flow_k = NULL, #k for flowsom
                          pheno_lou_kn = c(300,200,100), #kn for phenograph or louvain
                          lou_resolution = NULL, #resolution for louvain
                          run.plot = TRUE, #print if run
                          run.stats = TRUE, #print and return if run
                          save_to = NULL)

## clustree in phenograph doesn't make sense but I've included it to see it anyway
#
### stats are now in a list

```

```{r}
# try plot function for phenograph outputs
stats_plot(stats_ls = pheno.test,
                       save_to = output_path,
                       clust_method = "phenograph") 


```



Test functions Louvain

```{r}

output_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/exp_clusters/seu/"


lou.test <- explore_param(input = seu, #for phenograph and louvain only
                          cluster_method = "louvain", #take 1 cluster method
                          df_input = NULL, #needed  if input "flowsom"
                          flow_k = NULL, #k for flowsom
                          pheno_lou_kn = c(40,100), #kn for phenograph or louvain
                          lou_resolution = c(0.25,0.5,1), #resolution for louvain
                          run.plot = TRUE, #print if run
                          run.stats = TRUE, #print and return if run
                          save_to = NULL)


```

Check cluster stability - best resolution/cluster number/k value by calculating RAND Index and STD of cluster number

```{r}

RI <- Rand_index(input = seu,
                       resolutions = c(0.1,0.25,0.5,0.8,1),
                       kn = 60,
                       n = 10, #number of iterations
                       save_to = NULL  #if null, will not save seul, ril, ncl, rdf
)

# it is recommended to run n= 100, however I ran only 10 here because it is long to calculate


```

```{r}
 
#Look at the RI results
plot_randindex(
    rdf = RI$list,
    cp = c("orange", "violet"),
    view = c(0, 1) #zoom in x axis, this does not changes scales, just the viewable sections
)

# The RAND index indicates if cells are put into the same cluster each time the clustering is repeated - 1 mean they are exactly the same. We ran 10 times so there are 9 RI for each resolution.  There are 10 counts of the number of clusters (one for each iteration). Cluster number too low will not account for the true differences in groups, cluster numbers too high are difficult to annotate.


```

```{r}
 ## test RAND Index again with more res, less reps - add in the plotting
RI <- Rand_index(input = seu,
                       resolutions = c(0.05,0.1,0.2,0.3,0.4,0.5,0.6,0.75,1,1.25,1.5),
                       kn = 60,
                       n = 2, #number of iterations
                       save_to = NULL  #if null, will not save seul, ril, ncl, rdf
)

```



After checking parameters run cluster function to make add the clustering information into the 

```{r}

seu <- get_clusters(seu, method = "louvain",
                         df_input = NULL, #needed  if input "flowsom"
                         k = 60, #k for flowsom or kn for Phenograph and Seurat Louvain
                         resolution = 0.5,
                         plots = TRUE,
                         save_plots = FALSE)

```

```{r}
seu <- get_clusters(seu, method = "flowsom",
                         df_input = df.input, #needed  if input "flowsom"
                         k = 12, #k for flowsom or kn for Phenograph and Seurat Louvain
                         resolution = NULL,
                         plots = TRUE,
                         save_plots = FALSE) 


```







```{r}
# save with graph
saveRDS(seu,"/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/seu9000March08.RDS")



```



Annotate clusters
1. Visualization for manual annotation. - output by clustering function
2. CAM (Correlation assignment model) - requires reference matrix
3. RFM (Random Forest Model) - requires annotated matching flow dataset
4. Seurat label transfer - requires annotated matching flow data in a seurat object

Visualize expression on UMAP and with heat maps

```{r}

AB <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")


# this will let us see one at at time
for (i in AB) {
  print(FeaturePlot(seu, features = i, min.cutoff = 'q1', max.cutoff = 'q97', label = TRUE))
}


```

Some more visualization of expression values

```{r}

# summary heat map
# use function plotmean

length(unique(seu$RNA_snn_res.0.8))
# there are 22 clusters

cluster.num <- c(0:21)

plotmean(plot_type = 'heatmap',seu = seu, group = 'RNA_snn_res.0.8', markers = AB, 
                     var_names = cluster.num, slot = 'scale.data', xlab = "Cluster",
         ylab = "Antibody")


```





```{r}

output_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/"
saveRDS(seu, paste(output_path,"cluster9000.RDS"))

```

Predict cell annotations with CAM (Corralations assignment method)

```{r}

reference_path <- "/Users/rhalenathomas/GITHUB/CelltypeR/Data/ReferenceMatrix9celltypesOrdered.csv"

reference_data <- read.csv(reference_path)

cor <- find_correlation(df.input, 
                             reference_data, 
                             min_corr = 0.5, 
                             min_diff = 0.05)

# creates a dataframe with cor1 cor2 and predicted cell type label



```

Visualize the CAM results

```{r}

plot_corr(cor)


```

Apply correlation predictions to clusters and output a vector for annotation functions

```{r}


# add the correlation predictions to the meta data
seu <- AddMetaData(object=seu, metadata=cor$cell.label, col.name = 'cor.labels')
# see the labels added
unique(seu$cor.labels)

seu.cluster = seu$RNA_snn_res.0.8
seu.labels = seu$cor.labels

# plot the cluster predictions
plot_lab_clust(seu, seu$RNA_snn_res.0.8, seu$cor.labels)




```

Run get annotations function to return a vector of annotation in the order of the clusters.

```{r}

cor.ann <- get_annotation(seu, seu.cluster = seu$RNA_snn_res.0.8, 
                          seu.label = seu$cor.labels, top_n = 3, 
                          filter_out = c("Unknown","unknown","Mixed"), 
                          Label = "CAM")
cor.ann
dim(cor.ann)

cor.ann <- cor.ann[1:22,]
dim(cor.ann)

unique(cor.ann$CAM)
length(cor.ann$CAM)

```





Use a trained Random Forest model to predict cell types. 
Training of the Random Forest model with an annotated data set is below.

```{r}

# you must have a saved trained model from a data object annotated from the same markers

rf <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/PaperFigures/RFM_trained.11072022.Rds")


rfm.pred <- RFM_predict(seu, rf)
head(rfm.pred)

# add the predictions into the seurat object

seu <- AddMetaData(object=seu, metadata=rfm.pred$`predict(rf, df)`, col.name = 'rfm.labels')

# check that the data is added 
table(seu$rfm.labels)


```

Get the annotation by cluster for the RFM

```{r}

rfm.ann <- get_annotation(seu, seu$RNA_snn_res.0.8,seu$rfm.labels, 
               top_n = 3, filter_out = c("unknown","Unknown","Mixed","Mix"), Label = "RFM")
rfm.ann

#rfm.ann <- get_annotation(seu, seu$RNA_snn_res.0.8,seu$rfm.labels, 
 #              top_n = 3, filter_out = FALSE, Label = "RFM")
rfm.ann
dim(rfm.ann)

```

Plot RFM predictions

```{r}


plot_lab_clust(seu, seu.cluster = seu$RNA_snn_res.0.8, seu.labels = seu$rfm.labels, filter_out = c("unknown","Unknown","Mixed"))


```



Predicting cell types with Seurat label transfer using anchors


```{r}

# takes in a seurat object with the labels added 
# makes a dataframe with the count of predicted labels for each cluster
# input seurat object with the predicted labels in the meta data
# input the clusters meta data slot to be labels
# input the meta data slot with the labels (correlation, random forest, seurat predicted)

#need reference data object with labels
seu.r<- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/PaperFigures/Seu9000annot.08072021.RDS")


# the output is a seurat object with the predicted annotations

seu <- seurat_predict(seu, seu.r, ref_id = 'subgroups', down.sample = 500, markers = AB)




```

```{r}

# plot the seurat anchor predictions
# get the annotation table for the seurat anchor predictions 

plot_lab_clust(seu, seu$RNA_snn_res.0.8, seu$seu.pred)

# to not filter anything use c()
seu.ann <- get_annotation(seu, seu$RNA_snn_res.0.8,seu$seu.pred, 
               top_n = 3, filter_out = c(), Label = "Seurat")
seu.ann


```

Get a consensus of cluster annotations, Add the annotations to the seurat object



```{r}

# manual annotations
# quick cheat just using the seurat labels to get a sting of annotations

temp <- paste("'",as.character(seu.ann$Seurat), "'", collapse = ", ", sep = "" )

my_ann <- c('Unknown', 'Radial Glia 1', 'Astrocytes 1', 'Mixed', 'Neurons 1', 'Neurons 2', 'Epithelial', 'Astrocytes mature', 'NPC', 'Radial Glia 2', 'Radial Glia 3', 'Endothelial', 'Epithelial', 'Neurons 3', 'Neurons 1', 'Astrocytes 2', 'Neurons 1', 'Unknown', 'Oligodendrocytes', 'Stem-like 1', 'Neural stem', 'Epithelial')
cluster.n <- c(0:21)
man.ann <- data.frame(cluster.n, my_ann)
colnames(man.ann) <- c("Cluster","manual")

# needs to be factors 
man.ann <- data.frame(lapply(man.ann, factor))

dim(man.ann)
dim(cor.ann)
dim(rfm.ann)
dim(seu.ann)

# the dataframes must be the same length

# the annotation function takes in a list of the annotation dataframes

ann.list <- list(man.ann,df.cor.ann,rfm.ann,seu.ann)

# annotate the seurat object

seu <- cluster_annotate(seu, ann.list, 
                        annotation_name ="CellType", 
                        to_label = "RNA_snn_res.0.8")

DimPlot(seu, group.by = "CellType")


```

Just use the annotate functions

```{r}

seu <- annotate(seu, annotations = man.ann$manual, to_label = "RNA_snn_res.0.8", annotation_name = "MyCellType")

DimPlot(seu, group.by = "MyCellType")

```





```{r}
#save with the annotations
saveRDS(seu,"/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/seu9000Feb24.RDS")


```


Compare groups


```{r}

seu <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/seu9000Feb24.RDS")


```


Add the variables into the seurat object
```{r}
Genotype <- c("3450","3450","3450","AIW002","AIW002","AIW002","AJG001C","AJG001C","AJG001C")
ExDate <- c("0306","0317","0317","0306","0317","0317","0306","0317","0317")
Batch <- c("B","B","A","B","B","A","B","B","A")
Age <- c("273","284","263","273","284","263","273","284","263")

# Genotype
Idents(seu) <- "Sample"
cluster.ids <- Genotype
# vector with the new names - you need this vector from me

names(cluster.ids) <- levels(seu)    # get the levels
seu <- RenameIdents(seu, cluster.ids) # rename  
seu$Genotype <- Idents(seu)   # add a new dataslot

# Experiment date
Idents(seu) <- "Sample"
cluster.ids <- ExDate
# vector with the new names - you need this vector from me

names(cluster.ids) <- levels(seu)    # get the levels
seu <- RenameIdents(seu, cluster.ids) # rename  
seu$ExDate <- Idents(seu)   # add a new dataslot

# Batch
Idents(seu) <- "Sample"
cluster.ids <- Batch
# vector with the new names - you need this vector from me

names(cluster.ids) <- levels(seu)    # get the levels
seu <- RenameIdents(seu, cluster.ids) # rename  
seu$Batch <- Idents(seu)   # add a new dataslot

# days in final differentiation media
Idents(seu) <- "Sample"
cluster.ids <- Age
# vector with the new names - you need this vector from me

names(cluster.ids) <- levels(seu)    # get the levels
seu <- RenameIdents(seu, cluster.ids) # rename  
seu$DaysinCulture <- Idents(seu)   # add a new dataslot



```

Plots some variables

```{r}
# one plot
proportionplots(seu.q,seu.var = seu$Genotype, seu.lable = seu$CellType, groups = "Genotype")
# add colours
colours <- c("chocolate1","chocolate3","orange",
                   "lightsalmon", "pink","lightpink3",
                   "steelblue3","deepskyblue",
                   "plum3","purple",
                   "seagreen3","tomato4","burlywood3","grey90","brown",
             "royalblue3", "tan4","yellowgreen")

proportionplots(seu.q,seu.var = seu$Genotype, seu.lable = seu$CellType, groups = "Genotype", my_colours = colours)

```

```{r}
var.list <- list(seu$DaysinCulture,seu$Batch,seu$ExDate,seu$Genotype)
varnames <- c("Days in Culture", "Batch", "Experiment Date", "Genotype")
# plot all the variables of interest at once

plotproportions(seu, var.list = var.list, xgroup = seu$CellType, varnames = varnames, my_colours = c("blue","red"))




```


Heatmaps

```{r}

# make sure the order is correct
celltypes <- c("unknown","radial glia 1", "astrocytes 1", "mixed","neurons 1",
               "neurons 2", "epithelial", "astrocytes mature", "npc", "radial glia 2",
               "radial glia 3", "endothelial","neurons 3", "astrocytes 2",
               "oligodendrocytes", "stem-like 1","neural stem")

plotmean(plot_type = 'heatmap',seu = seu, group = 'CellType', markers = AB, 
                     var_names = celltypes, slot = 'scale.data', xlab = "Cell Type",
         ylab = "Antibody")


```
```{r}
# dot plot

og.order <- c("unknown","radial glia 1", "astrocytes 1", "mixed","neurons 1",
               "neurons 2", "epithelial", "astrocytes mature", "npc", "radial glia 2",
               "radial glia 3", "endothelial","neurons 3", "astrocytes 2",
               "oligodendrocytes", "stem-like 1","neural stem")

# make sure the terms are exactly the same and you don't miss any
new.order <- c("astrocytes 1","astrocytes 2","astrocytes mature",
               "endothelial","epithelial", "mixed","neurons 1",
               "neurons 2","neurons 3","neural stem","npc",
               "oligodendrocytes",
               "radial glia 1","radial glia 2","radial glia 3","stem-like 1",
               "unknown")
new.order <- rev(new.order)

AB.order <- c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4")

plotmean(plot_type = 'dotplot',seu = seu, group = 'CellType', markers = AB, 
                     var_names = celltypes, slot = 'scale.data', xlab = "Cell Type",
         ylab = "Antibody", var1order = new.order, var2order = AB.order)


```

Statistics comparing groups


```{r}

# prepare a dataframe for stats
# this function takes the annotated seurat object with all the variables already existing as metadata slots

# check what meta data slots exist in your object
colnames(seu@meta.data)



```


```{r}
# run the function

var.names <- c("Sample","DaysinCulture", "Batch", "ExDate", "Genotype", "CellType")

df.for.stats <- Prep_for_stats(seu, marker_list = AB, variables = var.names, 
                               marker_name = 'Marker')


# save the csv for later
write.csv(df.for.stats, "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/df4statsFeb26.csv")

head(df.for.stats)


```


First we have 3 variables: Experimental variable, Cell types, Markers
We want to compare the mean expression per group:
For all antibodies together in each cell type between a given variable (Genotype) (One way anova)
We want to compare each antibody separately for a given variable for each cell type (two way anova)

```{r}

df.means <- df.for.stats %>% group_by(Sample, CellType, Marker) %>%
  summarize(mean_value = mean(value), .groups = )

head(df.means)
dim(df.means)

#%>% left_join(df.for.stats, by = c("Sample","CellType","Marker")) 

df_means <- df.for.stats %>%
  group_by(Sample, CellType, Marker) %>%
  mutate(mean_value = mean(value)) %>%
  distinct(Sample, CellType, Marker, mean_value, .keep_all = TRUE) %>% select(-value)


get_means <- function(df, group_cols, value_col) {
  df_means <- df %>%
    group_by(across(all_of(group_cols))) %>%
    mutate(mean_value = mean(value)) %>%
    distinct(across(all_of(group_cols)), mean_value, .keep_all = TRUE) %>%
    select(-value)
  return(df_means)
}

df_means <- get_means(df.for.stats, group_cols = c("Sample","CellType","Marker"), value_col = "value")


head(df_means)
dim(df_means)





```
















Train Random Forest model
Requires a labelled seurat object
More cells will give higher accuracy but increase computation time.
Run in HPC with lots of cells


```{r}

rf <- RFM_train(seurate_object = seu, 
                             AB_list = AB, annotations = seu$CellType3,
                      split = c(0.8,0.2),
                      downsample = 20000,
                      seed = 222,
                      mytry = c(1:10),
                      maxnodes = c(12: 25),
                      trees = c(250, 500, 1000,2000),
                      start_node = 15)

save(rf, output_path,"trainedRFMFeb14.Rds")

```


