---
title: "CelltypeR workflow"
output: html_notebook
---

1. Data preprocessing
a.	Read FlowJo files into R.
b.	Create a data frame with intensity measurements for each marker for all samples within the experiment to be analyzed.  
c.	Harmonize data 
d.	Explore clusters


```{r}

input_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/FlowDataFiles/9MBO"
output_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary"

# 1.a Read in FlowJo Files 

# choose to downsample to 9000 where possible
# check this - I don't think it worked
flowset <- fsc_to_fs(input_path, downsample = 9000)
# down sample can be a number, 'none' or 'min'

# look at file names and rename with shorter sample names

sampleNames(flowset)
sampleNames(flowset) <- sampleNames(flowset) <- c("3450_0306","AIW002_0306","AJG001C_0306","3450_0317A","AIW002_0317A","AJG001C_0317A","3450_0317B","AIW002_0317B","AJG001C_0317B")
sampleNames(flowset)


# if we want to save the flowset object now we can 
# this would be read back in with flowset 
# 



```


Harmonize data to remove batch or technical variation

This requires us to look and see where there are two peaks to align. We need to visualize the peaks of the transformed data before aligning.

```{r}

# we can decided what level of processing to choose with the argument 'processing'
# biexp only applies a biexponential transformation
# align applies biexp transform and then aligns peaks
# retro (default), transforms, aligns and then reverse transforms
flowset_biexp <- harmonize(flowset, processing = 'biexp')
# we can visualize the peaks to see where there are two peaks for alignment

# we need to enter the column index for which peaks to align, the alignment for one or two peaks is not the same. 
#plotdensity_flowset(flowset)
plotdensity_flowset(flowset_biexp) # to see the peaks

flowset_align <- harmonize(flowset, processing = 'align', 
                           two_peaks = c(7:20),
                       one_peak = c(1:6,21), threshold = 0.01)

flowset_retro <- harmonize(flowset, processing = 'retro', 
                           two_peaks = c(7:20),
                       one_peak = c(1:6,21), threshold = 0.01)

df <- flowset_to_csv(flowset_retro)




```

Now we have made all the different processing of the fsc files.  We can visualize the intensity in cell density plots to see the alignment

```{r}
#plotdensity_flowset(flowset)
plotdensity_flowset(flowset_biexp)
plotdensity_flowset(flowset_align)
#plotdensity_flowset(flowset_retro)


```

Now we will make test out clustering.
For Seurat clustering and Phenograph we will make the Seurat object
Flowsome takes in the dataframe directly.


```{r}

# the function make_seu will take in the df of expression and Antibody/Marker list as a vector and create a seurat object. Values are scaled. Marker expression will be in the "RNA" slot. PCA is calculated using AB vector as the features 

AB <- c("AQP4", "CD24", "CD44","CD184","CD15","HepaCAM","CD29",
                         "CD56", "O4","CD140a","CD133","GLAST","CD71")
seu <- make_seu(df, AB_vector = AB)


```
Save dataframe and seurat object for later

```{r}

output_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/"

# to save the df for later
# write.csv(df, "pathway/filename.csv")
write.csv(df, paste(output_path,"df9000.csv", sep = ""))

# save the seurat object
saveRDS(seu, paste(output_path,"seu9000.RDS", sep = ""))



```


Start from saved preprocessing

```{r}

in_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/"
df <- read.csv(paste(in_path,"df9000.csv", sep = ""))
seu <- readRDS(paste(in_path,"seu9000.RDS", sep = ""))

```




Explore clustering conditions make plots and calculate intrinsic statistics


```{r}

### this always crashes - I'll try with only one k -
## I'll try on beluga with more

df2 <- df %>% dplyr::select(AB) # need to add this line into the main explore param function 

output_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/exp_clusters/flow/"

# this function is able to run 3 methods of clustering, but the computational will be time consuming and is not recommended 
# if using HPC it is most efficient to pass a vector of all three methods instead of running each method separately 

test.flowsom <- explore_param(input = seu, 
                       cluster_method = c("flowsom"),
                       df_input = df2,
                       for.flowsom.k = c(3), 
                       #for.phenograph.and.louvain.k = c(20),
                       #for.louvain.resolution = c(0.1),
                       save.stats = TRUE, 
                       save.plot = TRUE, 
                       output_path = output_path)

# if an output path is set the plots are saved
# a list object is returned
# stats can then be plotted from the list 

# note the df parameter must be left out or an error will occur.


```

See FlowSOM results


```{r}

#make some plots
stats_plot()


```



Continue exploring parameters - Using Phenograph

```{r}

output_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/exp_clusters/pheno/"

test.pheno <- explore_param(input = seu, 
                       cluster_method = c("phenograph"),
                       df_input = df2,
                       for.flowsom.k = c(2), 
                       for.phenograph.and.louvain.k = c(60),
                       for.louvain.resolution = c(0.2,0.8),
                       save.stats = TRUE, 
                       save.plot = TRUE, 
                       output_path = output_path)

```


Continue exploring parameters - Using Seurat Louvain method

```{r}
output_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/exp_clusters/seu/"



test.seu <- explore_param(input = seu, 
                       cluster_method = c("louvain"),
                       df_input = df2,
                       for.phenograph.and.louvain.k = c(20),
                       for.louvain.resolution = c(0.2),
                       save.stats = TRUE, 
                       save.plot = TRUE, 
                       output_path = output_path)


```

Annotate clusters
1. Visualization for manual annotation. - output by clustering function
2. CAM (Correlation assignment model) - requires reference matrix
3. RFM (Random Forest Model) - requires annotated matching flow dataset
4. Seurat label transfer - requires annotated matching flow data in a seurat object



```{r}

# run clustering with only desired conditions - use function - TEMP run directly 
Idents(seu) <- 'Sample'
seu <- subset(seu, downsample = 9000)

seu <- RunPCA(seu, features = AB)
seu <- FindNeighbors(seu, dims = 1:12, k.param = 60)
# must take one less than the number of antibodies 

seu <- FindClusters(seu, resolution = 0.8)
seu <- RunUMAP(seu, dims = 1:12, n.neighbors = 46, min.dist = 0.4,
               spread = 1.5)
DimPlot(seu)


```

```{r}

output_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/"
saveRDS(seu, paste(output_path,"cluster9000.RDS"))

```



```{r}
# read in the clustered unlabeled Seurat object and the expression data frame (for correlation)

output_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/annotate/"

#seu <- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/cluster9000.RDS")
#create the output pathway


test_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/testingLibrary/df9000.csv"
reference_path <- "/Users/rhalenathomas/GITHUB/PhenoID_single_cell_flow_cytometry_analysis/old/correlation/ReferenceMatrix9celltypesOrdered.csv"

test_data <- read.csv(test_path)
# dataframe output from fsc_df

reference_data <- read.csv(reference_path)

cor <- find_correlation(test_data, 
                             reference_data, 
                             min_corr = 0.45, 
                             min_diff = 0.05)

class(cor)
# creates a dataframe with cor1 cor2 and predicted cell type label

```

```{r}
plot_corr(cor)

```

Apply correlation predictions to clusters and output a vector for annotation functions

```{r}

seu.t <- seu

# add the meta data into the seurat object

seu.t <- AddMetaData(object=seu.t, metadata=cor$cell.label, col.name = 'cor.labels')
# see the labels added
unique(seu.t$cor.labels)

seu.clusters <- seu.t$RNA_snn_res.0.8
seu.lable <- seu.t$cor.labels

t.lables <- as.data.frame(table(seu.t$RNA_snn_res.0.8, seu.t$cor.labels))
pr.t.lables <- as.data.frame(prop.table(table(seu.t$RNA_snn_res.0.8, seu.t$cor.labels)))
t.lables$Freq <- as.double(t.lables$Freq)

# remove unknown
t.lab.known <- t.lables %>% filter(!Var2 == "unknown")

ggplot(t.lables, aes(y = Freq, x = Var1, fill = Var2)) + geom_bar(position = "stack", stat= "identity")
ggplot(t.lab.known, aes(y = Freq, x = Var1, fill = Var2)) + geom_bar(position = "stack", stat= "identity")

# find the top X in cell in the group

top.labs <- t.lables  %>% group_by(Var1)  %>% top_n(3, Freq)
sort.tops <- top.labs %>% as.data.frame() %>% arrange(desc(Freq))  %>% arrange(Var1) 
sort.tops

top.lab <- t.lables  %>% group_by(Var1)  %>% top_n(1, Freq)
sort.top <- top.labs %>% as.data.frame() %>% arrange(desc(Freq))  %>% arrange(Var1) 
sort.top


t.lab.known.top <- t.lab.known %>% group_by(Var1)  %>% top_n(1, Freq)





```


```{r}

# takes in a seurat object with the labels added 
# makes a dataframe with the count of predicted labels for each cluster
# input seurat object with the predicted labels in the meta data
# input the clusters meta data slot to be labels
# input the meta data slot with the labels (correlation, random forest, seurat predicted)

seu.clusters <- seu.t$RNA_snn_res.0.8
seu.lable <- seu.t$cor.labels

# run function
plot_lab_clust(seu.t, seu.clusters, seu.lable)






```

```{r}

# a function to get a dataframe for annotation

# takes in a seurat object with clusters and predicted labels
# takes the cluster meta data slot, the predicted labels slot
# take number of different top predictions per cluster to view



ann_cor.u <- get_annotation(seu.t, seu.clusters, seu.lable, top_n = 3, ignore_unknown = FALSE)
ann_cor <- get_annotation(seu.t, seu.clusters, seu.lable, top_n = 3, ignore_unknown = TRUE)




```

Get a concensus of cluster annotations, Add the annotations to the seurat object



```{r}

clusters <- "RNA_snn_res.0.8"



# function to take in dataframes of different predictions and a vector of manual annotation
# only one is required



Idents(seu) <- clusters
cluster.ids <- ann_cor[[2]]

names(cluster.ids) <- levels(seu)
seu <- RenameIdents(seu, cluster.ids)
seu$CellTypes <- Idents(seu)



DimPlot(seu, reduction = "umap", label = TRUE, group.by = 'CellTypes', repel = TRUE)



```



