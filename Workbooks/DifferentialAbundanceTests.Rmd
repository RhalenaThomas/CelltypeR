---
title: "R Notebook"
output: html_notebook
---

Test enrichment of cell types/ clusters between conditions using DCATS
https://htmlpreview.github.io/?https://github.com/linxy29/DCATS_anlysis/blob/master/vignette/Integrate_with_seurat.html
doi: 10.1186/s13059-023-02980-3


```{r}

## install dependencies
install.packages(c("MCMCpack", "matrixStats", "robustbase", "aod", "e1071"))
## dependencies for vignette
install.packages(c("SeuratObject", "Seurat", "robustbase", "aod", "e1071"))
devtools::install_github('satijalab/seurat-data')


```

```{r}
# install DCATS - without vignettes
devtools::install_github("holab-hku/DCATS")

```

Load libraries

```{r}
library(DCATS)
#library(SeuratData)
library(tidyverse)
library(Seurat)
```


```{r}
# read in the data to analyze 
pathway <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/NatMethodJuneSubmission/Figure4/"
seuAll <- readRDS(paste(pathway,"All9MOannaoteAug.RDS", sep = ""))

```

9 hMO samples with all cells
Check the data object
```{r}
DimPlot(seu, group.by = "Celltypes")
```

Started with an integrated, clustered annotated Seurat object
DCATS will do a differential abundance analysis
Since we has a seurat object with information about KNN graph, we can estimate the similarity matrix based on this.

```{r}
# we need a metat data slot with sample IDs - we already have this
# we do not have the intergation slot - we only have RNA (and this is really the protein levels in Flow)

knn_mat = knn_simMat(seu@graphs$RNA_snn, seu$Celltypes)
print(knn_mat)

```

Now get the count matrix which contains the number of cells for each type in each sample
Only two levels are permitted

```{r}
count_mat = table(seu$Sample, seu$Celltypes)
count_mat
```

Now we enter the design - the order of the vector should be taken from the above table
Only two levels are possible - I will put together 3450 and AJG001C and compare the two with AIW001

```{r}
design_mat = data.frame(condition = c("3450-AJG001C", "3450-AJG001C", "3450-AJG001C",
                                      "AIW002","AIW002","AIW002",
                                      "3450-AJG001C", "3450-AJG001C", "3450-AJG001C"))
# 
dcats_GLM(count_mat, design_mat, similarity_mat = knn_mat)

results <- dcats_GLM(count_mat, design_mat, similarity_mat = knn_mat)

```
From Vignette:
The ceoffs indicates the estimated values of coefficients, the coeffs_err indicates the standard errors of coefficients, the pvals indicates the p-values calculated from the Ward test, the LRT_pvals indicates the p-values calculated from the likelihood ratio test, and the fdr indicates the adjusted p-values given by Benjamini & Hochberg method.

The LRT_pvals can be used to define whether one cell type shows differential proportion among different conditions by setting threshold as 0.05 or 0.01. You can also use pvals or fdr if you need.


Visualize the DCATS results

```{r}
# Load the viridis package
library(viridis)

# Assuming your data is stored in a variable called 'results'
ceoffs <- as.data.frame(results[['ceoffs']])
LR_vals <- as.data.frame(results[['LR_vals']])
LRT_pvals <- as.data.frame(results[['LRT_pvals']])

# Convert to numeric
result_df <- data.frame(
  cell_type = rownames(ceoffs),
  ceoffs = as.numeric(ceoffs$condition),
  LR_vals = as.numeric(LR_vals$condition),
  LRT_pvals = as.numeric(LRT_pvals$condition)
)

# Set color based on LRT_pvals
result_df$color <- ifelse(result_df$LRT_pvals > 0.05, "grey", viridis(10)[1])

# Plotting
ggplot(result_df, aes(x = ceoffs, y = cell_type, size = LR_vals, color = color)) +
  geom_point() +
  scale_color_identity(guide = guide_legend(title = "LRT P-Values"),labels = c("< 0.05", "NS")) +  # Add labels argument
  labs(title = "Differential Proportions of Cell Types",
       x = "Coefficients",
       y = "Cell Types",
       size = "Likelyhood Ratio",
       color = "LR p-Values") +
  theme_minimal() +
  theme(legend.position = "right")


```

```{r}
unique(seu$ipsc)
```


To compare Lines pairwise from the 9 hMO samples data that has 3 iPSC lines.

AIW002 vs AJG001C
```{r}
# subset 
seuAll <- seu
Idents(seuAll) <- "IPSC"
seu <- subset(seuAll, idents = "3450", invert = TRUE)
unique(seu$IPSC)
# Remove the unwanted level from the metadata
seu$IPSC <- droplevels(seu$IPSC)
seu$Sample <- droplevels(seu$Sample)
# Now, unique levels should not include the unwanted level
unique(seu$IPSC)
levels(seu$Sample)
#DCATS test
# matrix
knn_mat = knn_simMat(seu@graphs$RNA_snn, seu$Celltypes)
#print(knn_mat)
# count table
count_mat = table(seu$Sample, seu$Celltypes)
count_mat
# identify categories


```

AIW002 vs AJG001C
```{r}
design_mat = data.frame(condition = c("AIW002","AIW002","AIW002",
                                      "AJG001C", "AJG001C", "AJG001C"))
# 
dcats_GLM(count_mat, design_mat, similarity_mat = knn_mat)

results <- dcats_GLM(count_mat, design_mat, similarity_mat = knn_mat)

```

AIW002 vs AJG001C visualize results
```{r}
# Assuming your data is stored in a variable called 'results'
ceoffs <- as.data.frame(results[['ceoffs']])
LR_vals <- as.data.frame(results[['LR_vals']])
LRT_pvals <- as.data.frame(results[['LRT_pvals']])

# Convert to numeric
result_df <- data.frame(
  cell_type = rownames(ceoffs),
  ceoffs = as.numeric(ceoffs$condition),
  LR_vals = as.numeric(LR_vals$condition),
  LRT_pvals = as.numeric(LRT_pvals$condition)
)

# Set color based on LRT_pvals
result_df$color <- ifelse(result_df$LRT_pvals > 0.05, "grey", viridis(10)[1])

# Plotting
ggplot(result_df, aes(x = ceoffs, y = cell_type, size = LR_vals, color = color)) +
  geom_point() +
  scale_color_identity(guide = guide_legend(title = "LRT P-Values"),labels = c("< 0.05", "NS")) +  # Add labels argument
  labs(title = "Differential Proportions of Cell Types",
       x = "Coefficients",
       y = "Cell Types",
       size = "Likelyhood Ratio",
       color = "LR p-Values") +
  theme_minimal() +
  theme(legend.position = "right")
```

AIW vs 3450 
```{r}
# subset 
Idents(seuAll) <- "IPSC"
seu <- subset(seuAll, idents = "AJG001", invert = TRUE) # removes AJG001C
unique(seuAll$IPSC)
# Remove the unwanted level from the metadata
seu$IPSC <- droplevels(seu$IPSC)
seu$Sample <- droplevels(seu$Sample)
# Now, unique levels should not include the unwanted level
unique(seu$IPSC)
levels(seu$Sample)
#DCATS test
# matrix
knn_mat = knn_simMat(seu@graphs$RNA_snn, seu$Celltypes)
#print(knn_mat)
# count table
count_mat = table(seu$Sample, seu$Celltypes)
count_mat
# identify categories
```
AIW vs 3450 
```{r}
design_mat = data.frame(condition = c("3450","3450","3450","AIW002","AIW002","AIW002"))
#
dcats_GLM(count_mat, design_mat, similarity_mat = knn_mat)

results <- dcats_GLM(count_mat, design_mat, similarity_mat = knn_mat)
```

AIW vs 3450 visualize results
```{r}
# Assuming your data is stored in a variable called 'results'
ceoffs <- as.data.frame(results[['ceoffs']])
LR_vals <- as.data.frame(results[['LR_vals']])
LRT_pvals <- as.data.frame(results[['LRT_pvals']])

# Convert to numeric
result_df <- data.frame(
  cell_type = rownames(ceoffs),
  ceoffs = as.numeric(ceoffs$condition),
  LR_vals = as.numeric(LR_vals$condition),
  LRT_pvals = as.numeric(LRT_pvals$condition)
)

# Set color based on LRT_pvals
result_df$color <- ifelse(result_df$LRT_pvals > 0.05, "grey", viridis(10)[1])

# Plotting
ggplot(result_df, aes(x = ceoffs, y = cell_type, size = LR_vals, color = color)) +
  geom_point() +
  scale_color_identity(guide = guide_legend(title = "LRT P-Values"),labels = c("< 0.05", "NS")) +  # Add labels argument
  labs(title = "Differential Proportions of Cell Types",
       x = "Coefficients",
       y = "Cell Types",
       size = "Likelyhood Ratio",
       color = "LR p-Values") +
  theme_minimal() +
  theme(legend.position = "right")
```
3450 vs AJG001C

```{r}
# subset 
Idents(seuAll) <- "IPSC"
seu <- subset(seuAll, idents = "AIW002", invert = TRUE) # removes AIW002
unique(seuAll$IPSC)
# Remove the unwanted level from the metadata
seu$IPSC <- droplevels(seu$IPSC)
seu$Sample <- droplevels(seu$Sample)
# Now, unique levels should not include the unwanted level
unique(seu$IPSC)
levels(seu$Sample)
#DCATS test
# matrix
knn_mat = knn_simMat(seu@graphs$RNA_snn, seu$Celltypes)
#print(knn_mat)
# count table
count_mat = table(seu$Sample, seu$Celltypes)
count_mat
# identify categories
```



