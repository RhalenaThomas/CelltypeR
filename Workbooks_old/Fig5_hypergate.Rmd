---
title: "Figure 5 hyper gate"
output: html_notebook
---


Read in the annotated dataset


```{r}

library(Seurat)
library(dplyr)
library(ggplot2)
library(reshape2)
library(hypergate)

# output path for data objects
outpath <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/PaperFigures/"
# output path for figures
output_path <- "/Users/rhalenathomas/Documents/Projects_Papers/PhenoID/ForFigures/"

seu <- readRDS(paste(outpath,"seuAllcells.15072022.Rds"))


```

Run hypergate

```{r}

# set the identity to the labels to by the hypergate input
Idents(seu) <- 'cell.types'

# down sample
i = 800
set.seed(i)
seu.down <- subset(x= seu, downsample = i)
DimPlot(seu.down)
table(seu.down$cell.types)

# create a matrix to be the input for hypergate
input.xm = as.matrix(GetAssayData(seu.down, slot = 'data'))
xm.t <- t(input.xm)
cluster.labels <- as.vector(seu.down$cell.types)




```

Run hypergate

```{r}

# make a vector of all the cells to gate

# first I will gate with all cell types
# the number of cells included will alter the gates

cell.types <- c("Astrocytes 1", "Astrocytes 2","Radial Glia 1","Radial Glia 2",
                     "Epithelial","Endothelial","NPC","Neurons 1","Neurons 2",
                     "Oligodendrocytes","OPC","Stem cell like",
                "Glia Lineage","Neural Lineage")

# run gating and get the output
for (cell in cell.types) {
  hg_output <- hypergate(xp = xm.t, gate_vector = cluster.labels, level = cell)
  gating_predicted = subset_matrix_hg(hg_output,xm.t)
  conf.table <- table(ifelse(gating_predicted, "Gated-in", "Gated-out"), ifelse(cluster.labels ==  cell, cell, "Others"))
  print(cell)
  print(conf.table)
  print(hgate_rule(hg_output))
 
}


saveRDS(seu, (paste(outpath,"All9MOannaote.12072022.Rds")))


```


The accuracy doesn't change when you take fewer cells from the same grouping 
If I make the cell groupings different then it might change 

Merge together all the same cell types and see if accuracy is altered

```{r}

# I need to make neurons 1 neurons 2 Glia 1 and Glia2

# regroups all RG and all astro and check the accuracy
# these were are the cell type labels in 
Idents(seu.q) <- "seurat_clusters"
cluster.ids <- c("Glia Lineage","Neural Lineage","Radial Glia 1","Epithelial","Neurons 1",
                 "Radial Glia 2","Astrocytes 1","Astrocytes 1","Neurons 1","Radial Glia 2",
                 "Astrocytes 2","Radial Glia 1","Endothelial","Stem cell like","Neurons 1",
                 "Astrocytes 1","NPC","Neurons 2","Neurons 2","Astrocytes 1",
                 "Neurons 2","Astrocytes 1","Epithelial","Astrocytes 2","Epithelial",
                 "Radial Glia 2","Astrocytes 1","Neurons 2","Oligodendrocytes","Stem cell like",
                 "NPC","NPC","Astrocytes 2","Endothelial","OPC",
                 "Astrocytes 2")


# merge all the RG and merge all the astrocytes
# keep neurons, npc, oligo
# make all the other cells as 'other'

Idents(seu) <- "seurat_clusters"
cluster.ids <- c("ot","ot","Radial Glia","ot","Neurons 1",
                 "Radial Glia","Astrocytes","Astrocytes","Neurons 1","Radial Glia",
                 "Astrocytes","Radial Glia","ot","ot","Neurons 1",
                 "Astrocytes","NPC","Neurons 2","Neurons 2","Astrocytes",
                 "Neurons 2","Astrocytes","ot","Astrocytes","ot",
                 "Radial Glia","Astrocytes","Neurons 2","Oligodendrocytes","ot",
                 "NPC","NPC","Astrocytes","ot","ot",
                 "Astrocytes")



names(cluster.ids) <- levels(seu)
seu <- RenameIdents(seu, cluster.ids)
seu$gating.groups1 <- Idents(seu)

Idents(seu) <- 'gating.groups1'

# down sample
i = 1000
set.seed(i)
seu.down <- subset(x= seu, downsample = i)
DimPlot(seu.down)
table(seu.down$cell.types)

DimPlot(seu.down)

# create a matrix to be the input for hypergate
input.xm = as.matrix(GetAssayData(seu.down, slot = 'data'))
xm.t <- t(input.xm)
cluster.labels <- as.vector(seu.down$gating.groups1)

table(seu.down$gating.groups1)


cell.types <- c("Astrocytes","Radial Glia","NPC","Neurons 1","Neurons 2",
                     "Oligodendrocytes","ot")

# run gating and get the output
for (cell in cell.types) {
  hg_output <- hypergate(xp = xm.t, gate_vector = cluster.labels, level = cell)
  gating_predicted = subset_matrix_hg(hg_output,xm.t)
  conf.table <- table(ifelse(gating_predicted, "Gated-in", "Gated-out"), ifelse(cluster.labels ==  cell, cell, "Others"))
  print(cell)
  print(conf.table)
  print(hgate_rule(hg_output))
 
}





```


Read in the gated populations made in FlowJo

```{r}
# preprocess the data
library("flowCore") #Used for reading the data
library("ggplot2")
require("stringr") #set of functions to manipulate strings type in order to have nice titles
library("rlist") #set of functions that allows to easely manipulate lists
library("reshape2") #visualization
library("flowStats") #Alignment functions
library("scales") #scale colour intensity for visualization
library("dplyr")
#libraries
library("flowCore")



input_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/PaperFigures/GatingPopulations/gatedPopulations/"
output_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/PaperFigures/GatingPopulations/"

write_fcs_files <- TRUE #Set to true to write fcs files at each step (subsampled, transformed, aligned and scaled) - recommanded 

#Create output folder if it's not already created
if(dir.exists(output_path)==FALSE){ #check
  dir.create(output_path) #create directory
}


flowset <- read.flowSet(path=input_path,transformation = FALSE ,emptyValue = FALSE,truncate_max_range = FALSE, package="flowCore") #Create a flowset object
flowsetold <- read.flowSet(path="/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/FlowDataFiles/9MBO",transformation = FALSE ,emptyValue = FALSE,truncate_max_range = FALSE, package="flowCore")

flowset <- fsApply(flowset,function(x){x[ ,grepl("^[{'FJComp'}|{'FCS'}|{'SSC'}].*A$",colnames(flowset))]}) #Apply a function to flowSet (fsApply) that selects only the columns corresponding to areas values using "regular expression".



sampleNames(flowset)


```

```{r}

sampleNames(flowset) <- c("Astrocytes","Endothelial","Epithelial","Neurons1","Neurons2","NPC",
                          "Oligodendrocytes","RadialGlia","StemCellLike") #directly modify the names inside the flowset
sampleNames(flowset)

```

```{r}

# run the functions in the preprocessing scripts. These will be in a library
# thisi s the function to save

flowset_to_csv(flowset)#apply the function


```


```{r}

# read back in the flowset csv to create a new seurat object

df <- read.csv("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/PaperFigures/GatingPopulations/flowset.csv")
df2 <- df %>% dplyr::select(c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4"))
m <- as.matrix(df2)
# create the seurat object for visualization
tm <- t(df2)
rownames(tm) <- colnames(df2)
colnames(tm) <- rownames(df2)
seu <- CreateSeuratObject(tm)
# for later to see features we define the vector here
AB <- colnames(df2)
# add the sample names into the seurat object 
seu <- AddMetaData(object=seu, metadata=df$Batch, col.name = 'GatedPop')
# prepare object to cluster
# prepare the object for clustering

table(seu$GatedPop)

seu <- ScaleData(seu)
# 231143 cells 

seu <- RunPCA(seu, features = AB, npcs = 12, approx = FALSE)
seu <- FindNeighbors(seu, dims = 1:12, k.param =60)
seu <- RunUMAP(seu, dims = 1:12, n.neighbors = 60, spread = 2, a=0.54,b=0.84, min.dist = 0.5)

seu <- FindClusters(seu, resolution = c(0.5,0.9,1.2))

outpath <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/PaperFigures/"
saveRDS(seu,paste(outpath,"FlowJogatedSeu.Rds"))

###  Now to visualize the cell types

DimPlot(seu, group.by = 'GatedPop')




# plot saving path
out_plots <- "/Users/rhalenathomas/Documents/Projects_Papers/PhenoID/ForFigures/"


png(paste(out_plots,"NewFeaturePLotsFlowJO.png"), width = 1200, height = 500)
FeaturePlot(seu, features = AB, slot = 'scale.data',min.cutoff = 'q3', max.cutoff ='q97')
dev.off()



Idents(seu) <- 'RNA_snn_res.1.2'
DimPlot(seu)
DimPlot(seu, group.by = 'GatedPop')

### make a UMAP of the gated in cell types


# change the order of the cell types on the legend of the umap
cell.type.order <- c("Astrocytes", "RadialGlia",
                     "Epithelial","Endothelial","NPC","Neurons1","Neurons2",
                     "Oligodendrocytes","StemCellLike")
cell.type.order <- rev(cell.type.order)
clust.colours <- c("chocolate1", "pink",
                   "steelblue3","deepskyblue","plum3","purple","orchid2",
                   "seagreen3","tomato3")


Idents(seu) <- 'GatedPop'
pdf(paste(out_plots,"UMAP.flowjo.gated.pop.pdf"),width = 12, height = 6)
DimPlot(seu, order = cell.type.order, cols = clust.colours, shuffle = TRUE, raster=FALSE,pt.size = 0.01, label = FALSE) +
  theme(legend.text = element_text(size=20), axis.title.y = element_text(size=20), 
        axis.title.x = element_text(size=20), axis.text.y = element_text(size =20),
        axis.text.x = element_text(size =20))
dev.off()


Idents(seu) <- 'seurat_clusters'
png(paste(out_plots,"UMAP.flowjo.gated.pop.seuratecluster.png"),width = 1200, height = 500)
DimPlot(seu,shuffle = TRUE, raster=FALSE,pt.size = 0.1, label = FALSE)+
  theme(legend.text = element_text(size=20), axis.title.y = element_text(size=20), 
        axis.title.x = element_text(size=20), axis.text.y = element_text(size =20),
        axis.text.x = element_text(size =20))
dev.off()

png(paste(out_plots,"HM.flowjo.gated.pop.seuratecluster.png"),width = 1200, height = 500)
DoHeatmap(seu, group.by = "seurat_clusters", features = AB, size= 6,slot = "scale.data", disp.max = 2, disp.min = -1.5) + scale_fill_gradientn(colors = c("#154c79", "#eeeee4", "#e28743")) + 
  theme(axis.text.y = element_text(size = 12))
dev.off




```


Annotate the dataset

```{r}

## seurat label transfer
seu.r<- readRDS("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/PaperFigures/Seu9000annot.08072021.RDS")

DimPlot(seu.r)

Idents(seu.r) <- 'subgroups'
seu.r <- subset(seu.r, downsample = 500)
table(seu.r$subgroups)

anchors <- FindTransferAnchors(reference = seu.r, query = seu,features = AB ,reference.reduction = "pca", dim= 1:10) 
predictions <- TransferData(anchorset = anchors, refdata = seu.r$subgroups, dims = 1:10)
seu <- AddMetaData(seu, metadata = predictions)


# save the Seurat predictions


# make the plots and the prediction tables
t.lables <- as.data.frame(table(seu$seurat_clusters, seu$predicted.id))
pr.t.lables <- as.data.frame(prop.table(table(seu$seurat_clusters, seu$predicted.id)))
t.lables$Freq <- as.double(t.lables$Freq)


# try bar chart
ggplot(t.lables, aes(y = Freq, x = Var1, fill = Var2)) + geom_bar(position = "stack", stat= "identity")

# find the top 2 in cell in the group

top.labs <- t.lables  %>% group_by(Var1)  %>% top_n(3, Freq)
top.labs

top.lab <- t.lables  %>% group_by(Var1)  %>% top_n(1, Freq)
top.lab




```

Add the annotation for the cell types and then I can look at which cell types are in each original input

```{r}

Idents(seu) <- "seurat_clusters"
cluster.ids <- c("Astro1","Neur1","Astro1","Neur2","Astro2",
                 "RG1",
                 "RG2","stem","stem","NPC","Neur2","epi1","epi2","Neur2","Astro2",
                 "Neur1","endo1","Neur2","Neur1","Neur1","RG1","NPC","Astro1",
                 "epi3","oligo","endo2","oligo"
                  )

names(cluster.ids) <- levels(seu)
seu<- RenameIdents(seu, cluster.ids)
seu$labels1 <- Idents(seu)

DimPlot(seu, reduction = "umap", label = TRUE, group.by = 'labels1', repel = TRUE)
DimPlot(seu, reduction = "umap", label = TRUE, group.by = 'seurat_clusters', repel = TRUE)


Idents(seu) <- "seurat_clusters"
cluster.ids <- c("Astrocytes 1","Neurons 1","Astrocytes 1","Neurons 2",
                 "Astrocytes 2","Radial Glia 1","Radial Glia 2",
                 "Stem cell like","Stem cell like","NPC","Neurons 2",
                 "Endothelial","Endothelial","Neurons 2","Astrocytes 2",
                 "Neurons 1","Epithelial","Neurons 2","Neurons 1",
                 "Neurons 1","Radial Glia 1","NPC","Astrocytes 1",
                 "Endothelial","Oligodendrocytes","Epithelial","Oligodendrocytes"
                  )

names(cluster.ids) <- levels(seu)
seu<- RenameIdents(seu, cluster.ids)
seu$cell.ids <- Idents(seu)

DimPlot(seu,label = TRUE, repel = TRUE, group.by = 'cell.ids')


```

Get the count of these cell types in each of the gated groups.


```{r}


# make the plots and the prediction tables
t.lables <- as.data.frame(table(seu$GatedPop,seu$cell.ids))
pr.t.lables <- as.data.frame(prop.table(table(seu$GatedPop,seu$cell.ids)))
t.lables$Freq <- as.double(t.lables$Freq)


# try bar chart
ggplot(t.lables, aes(y = Freq, x = Var1, fill = Var2)) + geom_bar(position = "stack", stat= "identity")
  
clust.colours <- c("chocolate1","orange","lightsalmon", "pink",
                   "steelblue3","deepskyblue","plum3","purple","orchid2",
                   "seagreen3","tomato3")

df <- pr.t.lables

cell.type.order <- c("Astrocytes 1", "Astrocytes 2","Radial Glia 1","Radial Glia 2",
                     "Epithelial","Endothelial","NPC","Neurons 1","Neurons 2",
                     "Oligodendrocytes","Stem cell like")

cell.type.order <- rev(cell.type.order)
colnames(df) <- c("GatedCells","PhenoID.CellTypes","Freq")

df <- df %>% mutate(PhenoID.CellTypes = factor(PhenoID.CellTypes, levels= cell.type.order))

###### Figure 5B #####

pdf(paste(out_plots,"Bar.FlowJoGated.phenoID.prop.pdf"),width = 8, height = 6)
ggplot(df, aes(x = GatedCells, y=Freq ,fill = PhenoID.CellTypes)) + geom_bar(position= "fill", stat = "identity")  +
  RotatedAxis() +
  scale_y_continuous(labels = scales::percent_format()) + theme_classic() + theme(text = element_text(size=18),
        axis.text.x = element_text(angle=90, hjust=1, size = 18))  + xlab('Gated cell types') + ylab('Proportion of cell type')  + scale_fill_manual(values = clust.colours) + guides(fill=guide_legend(title="PhenoID cell type annotations"), element_text(size = 18))
dev.off()
 
# find the top 2 in cell in the group

top.labs <- t.lables  %>% group_by(Var1)  %>% top_n(3, Freq)
top.labs

top.lab <- t.lables  %>% group_by(Var1)  %>% top_n(1, Freq)
top.lab


```


New data from May 10th, 2022

Same gating and used in sorting from the whole population.

```{r}



input_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/PaperFigures/GatingPopulations/FlowJOgatingMay10samples/"
output_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/PaperFigures/GatingPopulations/"

write_fcs_files <- TRUE #Set to true to write fcs files at each step (subsampled, transformed, aligned and scaled) - recommanded 

#Create output folder if it's not already created
if(dir.exists(output_path)==FALSE){ #check
  dir.create(output_path) #create directory
}


flowset <- read.flowSet(path=input_path,transformation = FALSE ,emptyValue = FALSE,truncate_max_range = FALSE, package="flowCore") #Create a flowset object
flowsetold <- read.flowSet(path="/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/FlowDataFiles/9MBO",transformation = FALSE ,emptyValue = FALSE,truncate_max_range = FALSE, package="flowCore")

flowset <- fsApply(flowset,function(x){x[ ,grepl("^[{'FJComp'}|{'FCS'}|{'SSC'}].*A$",colnames(flowset))]}) #Apply a function to flowSet (fsApply) that selects only the columns corresponding to areas values using "regular expression".



sampleNames(flowset)

```


```{r}
sampleNames(flowset) <- c("Astrocytes","Neurons1","Neurons2","RadialGlia") #directly modify the names inside the flowset
sampleNames(flowset)




```

```{r}

# saveing function updated
# saving function
flowset_to_csv=function(flowset){  
  list_of_flowframes=fsApply(rename_markers(flowset),function(x){as.data.frame(x@exprs)})#Makes a list of dataframes
  list_names=names(list_of_flowframes)#extract names for not calling names() function at each loop
  for (index in seq_along(list_of_flowframes)){ #Iterates along the index for adding sample names
    list_of_flowframes[[index]]$Sample = list_names[index]
    colnames(list_of_flowframes[[index]]) = colnames(list_of_flowframes[[1]]) 
  }
  ds=list.rbind(list_of_flowframes)#binds every fcs file in a single dataframe
  ds$cell=as.factor(unlist(lapply(as.list(c(1:length(flowset))),function(x){c(1:nrow(flowset[[x]]@exprs))})))#add cell IDs - cell count per sample 
  write.csv(ds,file=paste0(output_path,deparse(substitute(flowset)),".csv"))#save the R data for further usage
}

output_path <- "/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/PaperFigures/May10GatingPopulations/"
may10 <- flowset

flowset_to_csv(may10)#apply the function

```


Read the csv data from flowset back in

```{r}

df.may10 <- read.csv("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/PaperFigures/May10GatingPopulations/may10.csv")


df.may10 <- read.csv("/Users/rhalenathomas/Documents/Data/FlowCytometry/PhenoID/Analysis/PaperFigures/GatingPopulations/flowset.csv")
df2 <- df.may10 %>% dplyr::select(c("CD24","CD56","CD29","CD15","CD184","CD133","CD71","CD44","GLAST","AQP4","HepaCAM", "CD140a","O4"))
m <- as.matrix(df2)
# create the seurat object for visualization
tm <- t(df2)
rownames(tm) <- colnames(df2)
colnames(tm) <- rownames(df2)
seu <- CreateSeuratObject(tm)
# for later to see features we define the vector here
AB <- colnames(df2)
# add the sample names into the seurat object 
seu <- AddMetaData(object=seu, metadata=df.may10$Sample, col.name = 'GatedPop')
# prepare object to cluster
# prepare the object for clustering

table(seu$GatedPop)

seu <- ScaleData(seu)


```

Make ridge plots for each antibody

```{r}

library(Seurat)

my_levels <- c("Astrocytes","RadialGlia", "Neurons1","Neurons2")
seu$GatedPop <- factor(x= seu$GatedPop, levels = my_levels)

pdf(paste(out_plots,"RidgeMay10gated.pdf"), width = 20, height = 20)
RidgePlot(seu, features = AB, cols = c("orange","pink","mediumpurple2","darkorchid2"), 
          group.by = 'GatedPop',ncol = 4, log = TRUE, slot = 'scale.data')
dev.off()



```


Annotate the May 10 gated data

```{r}


seu <- RunPCA(seu, features = AB, npcs = 12, approx = FALSE)
seu <- FindNeighbors(seu, dims = 1:12, k.param =60)
seu <- RunUMAP(seu, dims = 1:12, n.neighbors = 60, spread = 2, a=0.54,b=0.84, min.dist = 0.5)

seu <- FindClusters(seu, resolution = 1.2)

DimPlot(seu)

png(paste(out_plots,"UMAP.flowjo.May10.png"),width = 1200, height = 700)
DimPlot(seu, group.by = 'GatedPop', shuffle = TRUE, raster=FALSE,pt.size = 0.1, label = FALSE, 
        cols = c("orange","pink","mediumpurple2","darkorchid2"))+
  theme(legend.text = element_text(size=24), axis.title.y = element_text(size=24), 
        axis.title.x = element_text(size=24), axis.text.y = element_text(size =24),
        axis.text.x = element_text(size =24))
dev.off()


png(paste(out_plots,"UMAP.flowjo.May10.clusters.png"),width = 1200, height = 700)
DimPlot(seu, group.by = 'seurat_clusters', shuffle = TRUE, raster=FALSE,pt.size = 0.1, label = TRUE,
        label.size = 7)+
  theme(legend.text = element_text(size=24), axis.title.y = element_text(size=24), 
        axis.title.x = element_text(size=24), axis.text.y = element_text(size =24),
        axis.text.x = element_text(size =24))
dev.off()





```


Label transfer to annotate

```{r}


Idents(seu.r) <- 'subgroups'
seu.r <- subset(seu.r, downsample = 500)
table(seu.r$subgroups)

anchors <- FindTransferAnchors(reference = seu.r, query = seu,features = AB ,reference.reduction = "pca", dim= 1:10) 
predictions <- TransferData(anchorset = anchors, refdata = seu.r$subgroups, dims = 1:10)
seu <- AddMetaData(seu, metadata = predictions)


# save the Seurat predictions


# make the plots and the prediction tables
t.lables <- as.data.frame(table(seu$seurat_clusters, seu$predicted.id))
pr.t.lables <- as.data.frame(prop.table(table(seu$seurat_clusters, seu$predicted.id)))
t.lables$Freq <- as.double(t.lables$Freq)


# try bar chart
ggplot(t.lables, aes(y = Freq, x = Var1, fill = Var2)) + geom_bar(position = "stack", stat= "identity")

# find the top 2 in cell in the group

top.labs <- t.lables  %>% group_by(Var1)  %>% top_n(3, Freq)
top.labs

top.lab <- t.lables  %>% group_by(Var1)  %>% top_n(1, Freq)
top.lab



```


Add cell type annotations

```{r}


png(paste(out_plots,"UMAP.flowjo.May10.predictid.png"),width = 1200, height = 700)
DimPlot(seu, group.by = 'predicted.id', shuffle = TRUE, raster=FALSE,pt.size = 0.1, label = TRUE, repel = TRUE, label.size = 6)+
  theme(legend.text = element_text(size=24), axis.title.y = element_text(size=24), 
        axis.title.x = element_text(size=24), axis.text.y = element_text(size =24),
        axis.text.x = element_text(size =24))
dev.off()




Idents(seu) <- "seurat_clusters"
cluster.ids <- c("RG2-1","Neur2a","RG1a","RG1-2","RG1b",
                 "Neur2b", "RG1c","RG1d", "Uk-RG-N", "Unknown1",
                 "RG2","Mix-RG-A","Neur1","U-RG", "Unknown2",
                 "RG1e","Neur3","RG1f","Unk-RG","Neur2c","Un3",
                 "Uk4","Oligo","RG2b" )

names(cluster.ids) <- levels(seu)
seu<- RenameIdents(seu, cluster.ids)
seu$labels1 <- Idents(seu)

DimPlot(seu, reduction = "umap", label = TRUE, group.by = 'labels1', repel = TRUE)


Idents(seu) <- "seurat_clusters"
cluster.ids <- c("RadialGlia2","Neurons2","Astrocytes1","Astrocytes1","RadialGlia1",
                 "Neurons2", "Astrocytes1","Astrocytes2", "RadialGlia", "Unknown",
                 "Astrocyte2","RadialGlia","Neurons1","RadialGlia", "Unknown",
                 "Astrocytes2","Neurons3","Glia","RadialGlia","Neurons2","Unknown",
                 "Unknown","Oligo","RadialGlia2" )

names(cluster.ids) <- levels(seu)
seu<- RenameIdents(seu, cluster.ids)
seu$labels1 <- Idents(seu)

DimPlot(seu, reduction = "umap", label = TRUE, group.by = 'labels1', repel = TRUE)



## anotated

png(paste(out_plots,"UMAP.flowjo.May10.label1.png"),width = 1200, height = 700)
DimPlot(seu, group.by = 'labels1', shuffle = TRUE, raster=FALSE,pt.size = 0.1, label = TRUE, repel = TRUE, label.size = 8)+
  theme(legend.text = element_text(size=24), axis.title.y = element_text(size=24), 
        axis.title.x = element_text(size=24), axis.text.y = element_text(size =24),
        axis.text.x = element_text(size =24))
dev.off()




# make the plots and the labels tables
t.lables <- as.data.frame(table(seu$GatedPop, seu$labels1))
pr.t.lables <- as.data.frame(prop.table(table(seu$GatedPop, seu$labels1)))
t.lables$Freq <- as.double(t.lables$Freq)


# try bar chart
ggplot(t.lables, aes(y = Freq, x = Var1, fill = Var2)) + geom_bar(position = "stack", stat= "identity")
ggplot(pr.t.lables, aes(y = Freq, x = Var1, fill = Var2)) + geom_bar(position = "stack", stat= "identity")


# find the top 2 in cell in the group

top.labs <- t.lables  %>% group_by(Var1)  %>% top_n(3, Freq)
top.labs

top.lab <- t.lables  %>% group_by(Var1)  %>% top_n(1, Freq)
top.lab



df <- pr.t.lables

cell.type.order <- c("Astrocytes1", "Astrocytes2","RadialGlia","RadialGlia1","RadialGlia2",
                     "Glia",
                     "Neurons1","Neurons2","Neurons3","Unknown","Oligo")

cell.type.order <- rev(cell.type.order)
colnames(df) <- c("GatedCells","PhenoID.CellTypes","Freq")

df <- df %>% mutate(PhenoID.CellTypes = factor(PhenoID.CellTypes, levels= cell.type.order))



png(paste(out_plots,"Bar.FlowJoGated.May10.phenoID.prop.png"),width = 500, height = 400)
ggplot(df, aes(x = GatedCells, y=Freq ,fill = PhenoID.CellTypes)) + geom_bar(position= "fill", stat = "identity")  +
  RotatedAxis() +
  scale_y_continuous(labels = scales::percent_format()) + theme_classic() + theme(text = element_text(size=18),
        axis.text.x = element_text(angle=90, hjust=1, size = 18))  + xlab('Gated cell types') + ylab('Proportion of cell type')  + scale_fill_manual(values = clust.colours) + guides(fill=guide_legend(title="PhenoID cell type annotations"), element_text(size = 18))
dev.off()






```





